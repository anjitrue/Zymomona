---
title: "MethodComparison_Eclipse02"
author: "Anji"
date: "October 25, 2020"
  html_document:
    df_print: paged
---
```{r setup, include=FALSE}
require(knitr)
opts_knit$set(root.dir = "E:/EAT/Projects/Proteomics/Infusion_FAIMS/DataAnalysis/SkylineOutput/")
knitr::opts_chunk$set(root.dir = "E:/EAT/Projects/Zymomona_direct_Infusion/", warning = FALSE, message = FALSE)
```

```{r install_packages, echo=FALSE}
library(pcaMethods)
library(ggplot2)
library(plotly)
library(reshape2)
library(plyr)
library(tidyr)
library(pheatmap)

```

```{r load_PRM_DDA_data, echo=FALSE}
# Read in csv files that were generated in skyline-daily DDA 45 min LC-MS/MS peak picking of 6 peptides - using high resolution library
DDA_PRM_AIEIVDQALDR <- read.csv("E:/EAT/Projects/Proteomics/Infusion_FAIMS/DataAnalysis/SkylineOutput/oldDigest_DDA/AIEIVDQALDR_peakArea_timepoint120_skylineDaily_highResLibrary.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

DDA_PRM_GLPVVDATCPLVNK <- read.csv("E:/EAT/Projects/Proteomics/Infusion_FAIMS/DataAnalysis/SkylineOutput/oldDigest_DDA/GLPVVDATCPLVNK_peakArea_timepoint120_skylineDaily_highResLibrary.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

DDA_PRM_FTDVIGPDTSDICYATQNR <- read.csv("E:/EAT/Projects/Proteomics/Infusion_FAIMS/DataAnalysis/SkylineOutput/oldDigest_DDA/FTDVIGPDTSDICYATQNR_peakArea_timepoint120_skylineDaily_highResLibrary.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

DDA_PRM_ETDIGVTGGGQGK <- read.csv("E:/EAT/Projects/Proteomics/Infusion_FAIMS/DataAnalysis/SkylineOutput/oldDigest_DDA/ETDIGVTGGGQGK_peakArea_timepoint120_skylineDaily_highResLibrary.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

DDA_PRM_VSLSADPEQEVR <- read.csv("E:/EAT/Projects/Proteomics/Infusion_FAIMS/DataAnalysis/SkylineOutput/oldDigest_DDA/VSLSADPEQEVR_peakArea_timepoint120_skylineDaily_highResLibrary.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

DDA_PRM_AVDCPLHLGITEAGGLIGGTVK <- read.csv("E:/EAT/Projects/Proteomics/Infusion_FAIMS/DataAnalysis/SkylineOutput/oldDigest_DDA/AVDCPLHLGITEAGGLIGGTVK_RedonepeakArea_timepoint120_skylineDaily_highResLibrary.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)




```

I reformatted both the Skyline .csv files to extract ISPH and ISPG peptide data and the three associated ISPH peptides **AIEIVDQALDR**, **GLPVVDATCPLVNK**, and **FTDVIGPDTSDICYATQNR** and the three associated ISPG peptides are **VSLSADPEQEVR**, **ETDIGVTGGGQGK**, and **AVDCPLHLGITEAGGLIGGTVK**

I built the following functions that format data frames.  
1. *Summed_precursor* takes either the DDA or PRM skyline output and wrangles the data to append meta data with summed precusor information and calls on the *FC_summed_precusor* to calculate the fold change relative to wild type.  
2. *aggregate_precursor* calculates the aggregate average, stdev, and %CV. Run *Summed_precursor* before running aggregated function.
3. *FC_summed_precusor* calculates the fold change of the respective DDA and PRM data.


```{r Sum_precursor, echo=FALSE}
#df <- DDA_PRM_AIEIVDQALDR
#analysis_type <- "DDA"

Summed_precusor <- function(df){
  
  #Extract sample names and reformat
  RAW_Sample_names <- df[,1]
  Sample_names <- sub("_45min.*", "", RAW_Sample_names)
  Sample_names <- sub("_","-", Sample_names)
  Sample_meta <- as.data.frame(Sample_names) %>% separate(Sample_names, into = paste("V", 1:4, sep = "-"))
  # replace the empty spots with "DDA" analysis type
  Sample_meta[is.na(Sample_meta)] <- "DDA"
  
  # Create a meta data frame
  Sample_meta$`V-3` <- paste0(Sample_meta$`V-1`, "-", Sample_meta$`V-4`)
  
  #Extract colmumns with precursor in it
  precusor_data <- df[,grep("precursor", colnames(df))]
  
  #Create new dataframe to only meta and precursor information
  #Fix precursor name
  df_meta_precursor <- cbind(Sample_names, Sample_meta,precusor_data) 
  colnames(df_meta_precursor) <- c("Sample_Names", "Sample_Type", "Replicate", "Sample_Analysis", "Analysis_Type", "precursor_1",
                                   "precursor_M1_2", "precursor_M2_3")
  
  #Append Summed precursor to dataframe
  df_meta_precursor$Sum_Precursor <- apply(df_meta_precursor[,grep("precursor", colnames(df_meta_precursor))], 1, sum)
  
    
  df_meta_precursor_FC <- FC_summed_precusor(df_meta_precursor)
    
  return(df_meta_precursor_FC)
}


  
aggregate_precursor <- function(df_meta_precursor){
  
  aggregate_sum_precursor <- aggregate(df_meta_precursor$Sum_Precursor,
                                list(df_meta_precursor$Sample_Analysis), mean)
  
  aggregate_sum_precursor$stdev <- aggregate(df_meta_precursor$Sum_Precursor,
                                list(df_meta_precursor$Sample_Analysis), sd)[[2]]
  
  aggregate_sum_precursor$log2Average <- log2(aggregate_sum_precursor$x)
  
  aggregate_sum_precursor$log2Stdev <- aggregate(df_meta_precursor$Sum_Precursor,
                                list(df_meta_precursor$Sample_Analysis), function(x) sd(log2(x)))[[2]]
  
  aggregate_sum_precursor$CV <- aggregate_sum_precursor$stdev/aggregate_sum_precursor$x*100
  
  colnames(aggregate_sum_precursor) <- c("Sample_Type", "Average_Sum", "Stdev_Sum", "Log2Average_Sum", "Stdev_Log2Sum", "%CV")
  
  ggplot(aggregate_sum_precursor, aes(Sample_Type, Log2Average_Sum))+
  geom_point()
  
  return(aggregate_sum_precursor)
}



FC_summed_precusor <- function(df){
  
  #create an empty vector and extract WT_DDA data from WT_PRM data
  v = vector()
  WT_DDA <- df[grep("WT-DDA",df$Sample_Analysis),]
  WT_PRM <- df[grep("WT-PRM",df$Sample_Analysis),]
  
  # iterate through each row and determine if we will calculate FC relative to the WT_DDA or WT_PRM
  # append to the empty vector V
    for (j in 1:nrow(df)) {
      for (i in 1:3) {
        if(length(grep("DDA", df$Sample_Analysis[j])) != 0){
            paste0(df$Sample_Names[j]," ", df$Sample_Analysis[j])
            if(length(grep(i,df$Replicate[j])) != 0){
              v <- append(v,df$Sum_Precursor[j]/WT_DDA$Sum_Precursor[i])
          paste0(WT_DDA$Sample_Names[i])
          print(v)
          }
        }else{
          paste0(df$Sample_Names[j]," ", df$Sample_Analysis[j])
          if(length(grep(i,df$Replicate[j])) != 0){
            v <- append(v,df$Sum_Precursor[j]/WT_PRM$Sum_Precursor[i])
        paste0(WT_PRM$Sample_Names[i])
        print(v)
        }

      }
      }
    }
  
  # Add the vector v to the dataframe
  df$FC_summedPrecursor <- v
  return(df)
  }
```


Apply the *Summed_precursor* funtions to the DDA and PRM data collected by LC-MS/MS without the standard spiked in. This will create dataframes for each of the peptides.
```{r DDA_PRM_DataAnalysis, echo=FALSE}


FC_AIEIVDQALDR <- Summed_precusor(DDA_PRM_AIEIVDQALDR)
  
FC_GLPVVDATCPLVNK <- Summed_precusor(DDA_PRM_GLPVVDATCPLVNK)

#Average one of the outliers
FC_GLPVVDATCPLVNK$Sum_Precursor[13] <- (FC_GLPVVDATCPLVNK$Sum_Precursor[14]+FC_GLPVVDATCPLVNK$Sum_Precursor[15])/2
FC_GLPVVDATCPLVNK$FC_summedPrecursor[1] <- FC_GLPVVDATCPLVNK$Sum_Precursor[1]/FC_GLPVVDATCPLVNK$Sum_Precursor[13]
FC_GLPVVDATCPLVNK$FC_summedPrecursor[7] <- FC_GLPVVDATCPLVNK$Sum_Precursor[7]/FC_GLPVVDATCPLVNK$Sum_Precursor[13]
  
FC_FTDVIGPDTSDICYATQNR <- Summed_precusor(DDA_PRM_FTDVIGPDTSDICYATQNR)
  
FC_ETDIGVTGGGQGK <- Summed_precusor(DDA_PRM_ETDIGVTGGGQGK)

FC_VSLSADPEQEVR  <- Summed_precusor(DDA_PRM_VSLSADPEQEVR)

FC_AVDCPLHLGITEAGGLIGGTVK <- Summed_precusor(DDA_PRM_AVDCPLHLGITEAGGLIGGTVK)

#These are vectors with the appropriate peptides for each protein we are monitoring 
IspH_peptide <- c("AIEIVDQALDR", "GLPVVDATCPLVNK", "FTDVIGPDTSDICYATQNR")
IspG_peptide <- c("ETDIGVTGGGQGK", "VSLSADPEQEVR", "AVDCPLHLGITEAGGLIGGTVK")

# Add some extra columns with peptide descriptors
FC_AIEIVDQALDR$peptide <- rep("AIEIVDQALDR", nrow(FC_AIEIVDQALDR))
FC_GLPVVDATCPLVNK$peptide <- rep("GLPVVDATCPLVNK", nrow(FC_GLPVVDATCPLVNK))
FC_FTDVIGPDTSDICYATQNR$peptide <- rep("FTDVIGPDTSDICYATQNR", nrow(FC_FTDVIGPDTSDICYATQNR))
FC_ETDIGVTGGGQGK$peptide <- rep("ETDIGVTGGGQGK", nrow(FC_ETDIGVTGGGQGK))
FC_VSLSADPEQEVR$peptide <- rep("VSLSADPEQEVR", nrow(FC_VSLSADPEQEVR))
FC_AVDCPLHLGITEAGGLIGGTVK$peptide <- rep("AVDCPLHLGITEAGGLIGGTVK", nrow(FC_AVDCPLHLGITEAGGLIGGTVK))

# Rbind all peptide dataframes into one big data frame
FC_allPeptides <- rbind(FC_AIEIVDQALDR, FC_GLPVVDATCPLVNK, FC_FTDVIGPDTSDICYATQNR, FC_ETDIGVTGGGQGK, FC_VSLSADPEQEVR, FC_AVDCPLHLGITEAGGLIGGTVK)
# Add some extra columns with protein descriptors
FC_allPeptides$Sample_Analysis_peptide <- paste0(FC_allPeptides$Sample_Analysis,"-",FC_allPeptides$peptide)
FC_allPeptides$Protein_OE <- c(rep("ISPH",54), rep("ISPG", 54))

# Remove unwanted data and keep only FC that will be plotted
FC_allPeptides_OE <- FC_allPeptides
FC_allPeptides_OE_ISPH <- FC_allPeptides_OE[FC_allPeptides_OE$Protein_OE == "ISPH",]
   FC_allPeptides_OE_ISPH <- FC_allPeptides_OE_ISPH[-grep("WT", FC_allPeptides_OE_ISPH$Sample_Names),]
   FC_allPeptides_OE_ISPH <- FC_allPeptides_OE_ISPH[-grep("ISPG", FC_allPeptides_OE_ISPH$Sample_Names),]

FC_allPeptides_OE_ISPG <- FC_allPeptides_OE[FC_allPeptides_OE$Protein_OE == "ISPG",]
  FC_allPeptides_OE_ISPG <- FC_allPeptides_OE_ISPG[-grep("WT", FC_allPeptides_OE_ISPG$Sample_Names),]
  FC_allPeptides_OE_ISPG <- FC_allPeptides_OE_ISPG[-grep("ISPH", FC_allPeptides_OE_ISPG$Sample_Names),]

# rebind cleaned-up dataframe and order the dataframe so that IspH peptides come first and then IspG peptides follow  
FC_allPeptides_OE_ISPH_ISPG <- rbind(FC_allPeptides_OE_ISPH, FC_allPeptides_OE_ISPG)
FC_allPeptides_OE_ISPH_ISPG$peptide <- as.factor(FC_allPeptides_OE_ISPH_ISPG$peptide)
FC_allPeptides_OE_ISPH_ISPG <- FC_allPeptides_OE_ISPH_ISPG %>%
  mutate(peptide = factor(peptide, level = c(IspH_peptide, IspG_peptide)))
```

```{r FoldChange_DDA_PRM_Plot, echo=FALSE}
# ggplot of FC for peptides that monitor OE - not log2 transformed
FC_allPeptides_OE_ISPH_ISPG$Sample_Type <- as.factor(FC_allPeptides_OE_ISPH_ISPG$Sample_Type)
p <- ggplot(FC_allPeptides_OE_ISPH_ISPG, aes(Sample_Analysis_peptide, FC_summedPrecursor), fill = as.factor(Sample_Type))+
  geom_boxplot()+
  scale_fill_manual(values = c("#5ABCB2", "#C3DE79"))+
  scale_y_continuous(breaks = seq(0,60,10), limit = c(0,60))+
  theme_light()+
  facet_grid(~peptide, scales = "free", space = "free")

p + theme(axis.text.x = element_text(angle = 50, hjust = 1)) + labs(title = "Fold Change Over Expressed Strain to Wild Type", 
                                                                    subtitle = "ISPH and and ISPG associted peptides",
                                                                    y = "Fold Change relative to Wild Type", x= "")

```

### Direct Infusion - Multiplex Data

```{r Load_DIF_data, echo=FALSE}
DIF_ETDIGVTGGGQGK_MultiPlex <- read.csv("P:/EAT_20190926_Zymomona/Zymo_TimeCourse/Infusions/NoFaims_halfdiluted/Diluted_120TimePoint_Multiplex_Eclipse02_DirectInfusion/CompiledFragmentResults_ETDIGVTGGGQGK_IsotopeDifferenceRecalculated.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

DIF_heavyETDIGVTGGGQGK_MultiPlex <- read.csv("P:/EAT_20190926_Zymomona/Zymo_TimeCourse/Infusions/NoFaims_halfdiluted/Diluted_120TimePoint_Multiplex_Eclipse02_DirectInfusion/CompiledFragmentResults_ETDIGVTGGGQGKheavy_IsotopeDifferenceRecalculated.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

DIF_AIEIVDQALDR_MultiPlex <- read.csv("P:/EAT_20190926_Zymomona/Zymo_TimeCourse/Infusions/NoFaims_halfdiluted/Diluted_120TimePoint_Multiplex_Eclipse02_DirectInfusion/CompiledFragmentResults_AIEIVDQALDR_IsotopeDifferenceRecalculated.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

DIF_heavyAIEIVDQALDR_MultiPlex <- read.csv("P:/EAT_20190926_Zymomona/Zymo_TimeCourse/Infusions/NoFaims_halfdiluted/Diluted_120TimePoint_Multiplex_Eclipse02_DirectInfusion/CompiledFragmentResults_AIEIVDQALDRheavy_IsotopeDifferenceRecalculated.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

library(RColorBrewer)
display.brewer.all()
scaleRYG <- colorRampPalette(c("white","orange","red"), space = "rgb")(31)
pheatmap(DIF_ETDIGVTGGGQGK_MultiPlex[,-c(1:2)],
         color = scaleRYG,
          labels_row = DIF_ETDIGVTGGGQGK_MultiPlex$Mass.Feature)
pheatmap(DIF_heavyETDIGVTGGGQGK_MultiPlex[,-c(1:2)],
         color = scaleRYG,
          labels_row = DIF_heavyETDIGVTGGGQGK_MultiPlex$Mass.Feature)
pheatmap(DIF_AIEIVDQALDR_MultiPlex[,-c(1:2)],
         color = scaleRYG,
          labels_row = DIF_AIEIVDQALDR_MultiPlex$Mass.Feature)
pheatmap(DIF_heavyAIEIVDQALDR_MultiPlex[,-c(1:2)],
         color = scaleRYG,
          labels_row = DIF_heavyAIEIVDQALDR_MultiPlex$Mass.Feature)

```

```{r Load_FAIMS_data, echo=FALSE}
FAIMS_ETDIGVTGGGQGK_MultiPlex <- read.csv("P:/EAT_20190926_Zymomona/Zymo_TimeCourse/Infusions/FAIMS_halfdiluted/TroubleShootFAIMS/CompiledFragmentResults_ETDIGVTGGGQGK_FAIMStroubleShoot_IsotopeDifferenceRecalculated.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

FAIMS_heavyETDIGVTGGGQGK_MultiPlex <- read.csv("P:/EAT_20190926_Zymomona/Zymo_TimeCourse/Infusions/FAIMS_halfdiluted/TroubleShootFAIMS/CompiledFragmentResults_ETDIGVTGGGQGKheavy_FAIMStroubleShoot_IsotopeDifferenceRecalculated.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

FAIMS_AIEIVDQALDR_MultiPlex <- read.csv("P:/EAT_20190926_Zymomona/Zymo_TimeCourse/Infusions/FAIMS_halfdiluted/TroubleShootFAIMS/CompiledFragmentResults_AIEIVDQALDR_FAIMStroubleShoot_IsotopeDifferenceRecalculated.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

FAIMS_heavyAIEIVDQALDR_MultiPlex <- read.csv("P:/EAT_20190926_Zymomona/Zymo_TimeCourse/Infusions/FAIMS_halfdiluted/TroubleShootFAIMS/CompiledFragmentResults_AIEIVDQALDRheavy_FAIMStroubleShoot_IsotopeDifferenceRecalculated.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

pheatmap(FAIMS_ETDIGVTGGGQGK_MultiPlex[,-c(1:2)],
         color = scaleRYG,
          labels_row = FAIMS_ETDIGVTGGGQGK_MultiPlex$Mass.Feature)
pheatmap(FAIMS_heavyETDIGVTGGGQGK_MultiPlex[,-c(1:2)],
         color = scaleRYG,
          labels_row = FAIMS_heavyETDIGVTGGGQGK_MultiPlex$Mass.Feature)
pheatmap(DIF_AIEIVDQALDR_MultiPlex[,-c(1:2)],
         color = scaleRYG,
          labels_row = DIF_AIEIVDQALDR_MultiPlex$Mass.Feature)
pheatmap(FAIMS_AIEIVDQALDR_MultiPlex[,-c(1:2)],
         color = scaleRYG,
          labels_row = FAIMS_AIEIVDQALDR_MultiPlex$Mass.Feature)
pheatmap(FAIMS_heavyAIEIVDQALDR_MultiPlex[,-c(1:2)],
         color = scaleRYG,
          labels_row = FAIMS_heavyAIEIVDQALDR_MultiPlex$Mass.Feature)

```

Next, I am reformatting DIF and FAIMS data - .csv files - generated by inhouse software. I extract heavy and light ISPH and ISPG peptides data.  
ISPH peptides **AIEIVDQALDR**, **GLPVVDATCPLVNK**, and **FTDVIGPDTSDICYATQNR**  
ISPG peptides are **VSLSADPEQEVR**, **ETDIGVTGGGQGK**, and **AVDCPLHLGITEAGGLIGGTVK**  

I built the following functions that format the infusion data frames.  
1. *Formatting_DFI_Summed_df* takes in dataframe, a string for either "light" or "heavy", the string peptide, and a numeric vector of selective transition ions for summing up. The output is a dataframe with meta data and either all transition ions summed or a selective number of ions. 
2. *df_totalIons_sum* calculates the the summattion of the transitions. I will look at how all transitions may have a different sensitivity than the marker transitions that are most representative of the peptide.
3. *FC_summed_precusor* calculates the fold change of the respective DDA and PRM data.
```{r, echo=FALSE}
df <- FAIMS_heavyETDIGVTGGGQGK_MultiPlex
peptide_Type <- "heavy"
peptide <- "ETDIGVTGGGQGK"
target_ions <- c("ETDIGVTGGGQGK","y7", "y8", "y9")
Ion_mobility <- "FAIMS"

Formatting_DFI_Summed_df <- function(df,peptide_Type, peptide,target_ions,Ion_mobility){
  
  #Extract sample names and reformat
  RAW_Sample_names_df <- colnames(df[,-c(1:2)])
  Sample_names <- sub("_.*", "", RAW_Sample_names_df)

  #Create a meta data
  Sample_meta <- as.data.frame(Sample_names) %>% separate(Sample_names, into = paste("V", 1:3, sep = "."))
  
  #Append more info to meta
  Sample_meta$Multiplex <- rep(peptide_Type, nrow(Sample_meta))
  Sample_meta$Peptide <- rep(peptide, nrow(Sample_meta))
  Sample_meta$Type <- paste0(Sample_meta$V.1, "_", Sample_meta$Multiplex,"_", Sample_meta$Peptide)
  Sample_meta$IonMobility <- rep(Ion_mobility, nrow(Sample_meta))
  
  v <- data.frame()
  #create a data frame with the summation of transition ions, where the summation of each transition is a row.
  for (i in 1:length(target_ions)) {
    v  <- rbind(v,c(target_ions[i],apply(df[which(df$Mass.Feature == target_ions[i]),-c(1:2)],2,sum)))
  }
  
  # Make the transitions dataframe numeric
  v <- apply(v[,-1], 1, as.numeric)
  # rename columns
  colnames(v) <- c(target_ions)
  
  # Column bind meta with the column that summs all transitions
  df_totalIons_sum <- cbind(Sample_meta,apply(df[,-c(1:2)],2,sum), v)
  
  # Rename columns
  colnames(df_totalIons_sum) <- c("Strain", "Replicate", "TimePoint", "AnalysisType", "Peptide", "Sample", "IonMobility", "TotalIonsSummed", target_ions)

# sum only the marker ions
  df_totalIons_sum$MarkerIonsSummed <- apply(df_totalIons_sum[,which(colnames(df_totalIons_sum) %in% target_ions)], 1, sum)

  
  return(df_totalIons_sum)
}

 df <- AIEIVDQALDR_light_summed 
 df_heavy <- AIEIVDQALDR_heavy_summed
 target_ions <- AIEIVDQALDR_target_ions

# Fold change funtion that uses FC_DIF_within to calculate the FC and the df_FC puts together the dataframe with the right bells and whistles. 
FoldChange_DFI <- function(df, df_heavy, target_ions){
  
  # Generate the fold change for the columns tha summed ions 
  df_FC <- FC_DIF_within(df, df[,grep("Summed", colnames(df))])
  
  # Replace rownames with some meta info
  rownames(df_FC) <- paste0(df_FC$Strain,"_", df_FC$Replicate,"_", df_FC$IonMobility, "_", df_FC$AnalysisType,"_", df_FC$Peptide)
  
  # New meta dataframe for the ratio data
  df_light_heavy_meta <- df[,1:7]
  
  # Calculate the ratio of light to heavy
  # Replace "light" with "ratio"
  df_light_heavy <- cbind(apply(df_light_heavy_meta, 2,  function(x) {sub("light", "ratio", x)}),df[,grep("Summed", colnames(df))]/df_heavy[,grep("Summed", colnames(df))])
  
  # Calculate the FC of light to heavy ratio
  light_heavy_ratio_FC <- FC_DIF_within(df_light_heavy, df_light_heavy[,grep("Summed", colnames(df_light_heavy))])
  # Replace rownames with some meta info 
  rownames(light_heavy_ratio_FC) <- paste0(light_heavy_ratio_FC$Strain,"_", light_heavy_ratio_FC$Replicate,"_", light_heavy_ratio_FC$IonMobility, "_", light_heavy_ratio_FC$AnalysisType,"_", light_heavy_ratio_FC$Peptide)
  
  df_meta_precursor_FC <- rbind(df_FC[,-(which(colnames(df_FC) %in% target_ions))], light_heavy_ratio_FC)
    
  return(df_meta_precursor_FC)
}

  df <- AIEIVDQALDR_light_summed
  df_sum <- df[,grep("Summed", colnames(df))]

FC_DIF_within <- function(df,df_sum){
  v = data.frame()
  WT <- df_sum[grep("WT",rownames(df_sum)),]
    
    for (j in 1:nrow(df_sum)){
      
        if(length(grep("120", rownames(df_sum)[j])) != 0){
          print(paste0("j=",j, " ", rownames(df_sum)[j]))
          
          for(i in 1:3){
           if(length(grep(paste0(i,".120"), rownames(df_sum)[j])) != 0){
              v <- rbind(v,df_sum[j,]/WT[i,])
              print(paste0("j=",j, " ", rownames(df_sum)[j],"/",rownames(WT[i,])))
           }
          }
        }else{
          for (i in 1:3) {
        if(length(grep(i, sub("_Multiplex.*", "", rownames(df_sum)[j]))) != 0){
              v <- rbind(v,df_sum[j,]/WT[i,])
        }
          }
      
}
    }
  colnames(v) <- c(paste0("FC_",colnames(v)[1]), paste0("FC_", colnames(v)[2]))
  df_out <- cbind(df,v)
  return(df_out)
}
```


```{r, echo=FALSE}
# df <- DIF_AIEIVDQALDR_MultiPlex
# peptide_Type <- "light"
# peptide <- "AIEIVDQALDR"
# target_ions <- c("y7", "y8", "y9")
#Ion_mobility <- "no_FAIMS"

AIEIVDQALDR_light_summed <- Formatting_DFI_Summed_df(DIF_AIEIVDQALDR_MultiPlex,"light","AIEIVDQALDR",c("AIEIVDQALDR","y7", "y8", "y9"), "no_FAIMS")
AIEIVDQALDR_heavy_summed <- Formatting_DFI_Summed_df(DIF_heavyAIEIVDQALDR_MultiPlex, "heavy","AIEIVDQALDR", c("AIEIVDQALDR[heavyArginine]","y7", "y8", "y9"), "no_FAIMS")

ETDIGVTGGGQGK_light_summed <- Formatting_DFI_Summed_df(DIF_ETDIGVTGGGQGK_MultiPlex,"light","ETDIGVTGGGQGK", c("ETDIGVTGGGQGK","y7", "y8", "y9"), "no_FAIMS")
ETDIGVTGGGQGK_heavy_summed <- Formatting_DFI_Summed_df(DIF_heavyETDIGVTGGGQGK_MultiPlex, "heavy","ETDIGVTGGGQGK", c("ETDIGVTGGGQGK[heavylysine]", "y7", "y8", "y9"), "no_FAIMS")

AIEIVDQALDR_FAIMS_light_summed <- Formatting_DFI_Summed_df(FAIMS_AIEIVDQALDR_MultiPlex,"light","AIEIVDQALDR",c("AIEIVDQALDR","y7", "y8", "y9"), "FAIMS")
AIEIVDQALDR_FAIMS_heavy_summed <- Formatting_DFI_Summed_df(FAIMS_heavyAIEIVDQALDR_MultiPlex, "heavy","AIEIVDQALDR", c("AIEIVDQALDR[heavyArginine]","y7", "y8", "y9"), "FAIMS")

ETDIGVTGGGQGK_FAIMS_light_summed <- Formatting_DFI_Summed_df(FAIMS_ETDIGVTGGGQGK_MultiPlex,"light","ETDIGVTGGGQGK", c("ETDIGVTGGGQGK", "y7", "y8", "y9"), "FAIMS")
ETDIGVTGGGQGK_FAIMS_heavy_summed <- Formatting_DFI_Summed_df(FAIMS_heavyETDIGVTGGGQGK_MultiPlex, "heavy","ETDIGVTGGGQGK", c("ETDIGVTGGGQGK[heavylysine]", "y7", "y8", "y9"), "FAIMS")



# df <- AIEIVDQALDR_light_summed
# df_heavy <- AIEIVDQALDR_heavy_summed


AIEIVDQALDR_target_ions = which(colnames(AIEIVDQALDR_light_summed) %in% c("AIEIVDQALDR","y7", "y8", "y9"))
AIEIVDQALDRheavy_target_ions = which(colnames(AIEIVDQALDR_heavy_summed) %in% c("AIEIVDQALDR[heavyArginine]","y7", "y8", "y9"))
if(AIEIVDQALDR_target_ions == AIEIVDQALDRheavy_target_ions){
  AIEIVDQALDR_light_ratio <- FoldChange_DFI(AIEIVDQALDR_light_summed,AIEIVDQALDR_heavy_summed, AIEIVDQALDR_target_ions)
   FC_AIEIVDQALDR_light_ratio <- AIEIVDQALDR_light_ratio[-grep("WT", AIEIVDQALDR_light_ratio$Strain),]
   FC_AIEIVDQALDR_light_ratio <- FC_AIEIVDQALDR_light_ratio [-grep("ISPG", FC_AIEIVDQALDR_light_ratio$Strain),]
}

ETDIGVTGGGQGK_target_ions = which(colnames(ETDIGVTGGGQGK_light_summed) %in% c("ETDIGVTGGGQGK","y7", "y8", "y9"))
ETDIGVTGGGQGKheavy_target_ions = which(colnames(ETDIGVTGGGQGK_heavy_summed) %in% c("ETDIGVTGGGQGK[heavylysine]","y7", "y8", "y9")) 
if(ETDIGVTGGGQGK_target_ions == ETDIGVTGGGQGKheavy_target_ions){
  ETDIGVTGGGQGK_light_ratio <- FoldChange_DFI(ETDIGVTGGGQGK_light_summed,ETDIGVTGGGQGK_heavy_summed, ETDIGVTGGGQGK_target_ions)
    FC_ETDIGVTGGGQGK_light_ratio <- ETDIGVTGGGQGK_light_ratio[-grep("WT", ETDIGVTGGGQGK_light_ratio$Strain),]
    FC_ETDIGVTGGGQGK_light_ratio <- FC_ETDIGVTGGGQGK_light_ratio [-grep("ISPH", FC_ETDIGVTGGGQGK_light_ratio$Strain),]
}
p <- ggplot(AIEIVDQALDR_light_ratio , aes(Sample, FC_MarkerIonsSummed), fill = as.factor(AnalysisType))+
  geom_boxplot()
p <- ggplot(ETDIGVTGGGQGK_light_ratio , aes(Sample, FC_MarkerIonsSummed), fill = as.factor(AnalysisType))+
  geom_boxplot()

AIEIVDQALDR_target_ions = which(colnames(AIEIVDQALDR_FAIMS_light_summed) %in% c("AIEIVDQALDR","y7", "y8", "y9"))
AIEIVDQALDRheavy_target_ions = which(colnames(AIEIVDQALDR_FAIMS_heavy_summed) %in% c("AIEIVDQALDR[heavyArginine]","y7", "y8", "y9"))
if(AIEIVDQALDR_target_ions == AIEIVDQALDRheavy_target_ions){
AIEIVDQALDR_FAIMS_light_ratio <- FoldChange_DFI(AIEIVDQALDR_FAIMS_light_summed,AIEIVDQALDR_FAIMS_heavy_summed, AIEIVDQALDR_target_ions)
   FC_AIEIVDQALDR_FAIMS_light_ratio <- AIEIVDQALDR_FAIMS_light_ratio[-grep("WT", AIEIVDQALDR_FAIMS_light_ratio$Strain),]
   FC_AIEIVDQALDR_FAIMS_light_ratio <- FC_AIEIVDQALDR_FAIMS_light_ratio [-grep("ISPG", FC_AIEIVDQALDR_FAIMS_light_ratio$Strain),]
}

ETDIGVTGGGQGK_target_ions = which(colnames(ETDIGVTGGGQGK_FAIMS_light_summed) %in% c("ETDIGVTGGGQGK","y7", "y8", "y9"))
ETDIGVTGGGQGKheavy_target_ions = which(colnames(ETDIGVTGGGQGK_FAIMS_heavy_summed) %in% c("ETDIGVTGGGQGK[heavylysine]","y7", "y8", "y9")) 
if(ETDIGVTGGGQGK_target_ions == ETDIGVTGGGQGKheavy_target_ions){
ETDIGVTGGGQGK_FAIMS_light_ratio <- FoldChange_DFI(ETDIGVTGGGQGK_FAIMS_light_summed,ETDIGVTGGGQGK_FAIMS_heavy_summed, target_ions)
   FC_ETDIGVTGGGQGK_FAIMS_light_ratio <- ETDIGVTGGGQGK_FAIMS_light_ratio[-grep("WT", ETDIGVTGGGQGK_FAIMS_light_ratio$Strain),]
   FC_ETDIGVTGGGQGK_FAIMS_light_ratio <- FC_ETDIGVTGGGQGK_FAIMS_light_ratio [-grep("ISPH", FC_ETDIGVTGGGQGK_FAIMS_light_ratio$Strain),]
}
p <- ggplot(FC_AIEIVDQALDR_FAIMS_light_ratio , aes(Sample, FC_MarkerIonsSummed), fill = as.factor(AnalysisType))+
  geom_boxplot()
p <- ggplot(FC_ETDIGVTGGGQGK_FAIMS_light_ratio , aes(Sample, FC_MarkerIonsSummed), fill = as.factor(AnalysisType))+
  geom_boxplot()


peptides_DIF_FAIMS_combined <- rbind(FC_AIEIVDQALDR_light_ratio, FC_ETDIGVTGGGQGK_light_ratio, FC_AIEIVDQALDR_FAIMS_light_ratio, FC_ETDIGVTGGGQGK_FAIMS_light_ratio)


p <- ggplot(peptides_DIF_FAIMS_combined, aes(Sample, FC_MarkerIonsSummed), fill = as.factor(Strtain))+
  geom_boxplot()+
  geom_jitter(aes(y=FC_MarkerIonsSummed), height = 0, width = 0.1)+
  scale_fill_manual(values = c("#5ABCB2", "#C3DE79"))+
  scale_y_continuous(breaks = seq(0,40,5), limit = c(0,40))+
  theme_light()+
  facet_grid(~IonMobility, scales = "free", space = "free")

p + theme(axis.text.x = element_text(angle = 50, hjust = 1)) + labs(title = "Fold Change Over Expressed Strain to Wild Type", 
                                                                    subtitle = "ISPH and and ISPG associted peptides",
                                                                    y = "Fold Change relative to Wild Type", x= "")



```


```{r, echo = FALSE}
#LC Data
aggregate_ETDIGVTGGGQGK <- aggregate_precursor(FC_ETDIGVTGGGQGK)
aggregate_ETDIGVTGGGQGK$Sample_Type <- paste0(aggregate_ETDIGVTGGGQGK$Sample_Type,"_","ETDIGVTGGGQGK")

aggregate_AIEIVDQALDR <- aggregate_precursor(FC_AIEIVDQALDR)
aggregate_AIEIVDQALDR$Sample_Type <- paste0(aggregate_AIEIVDQALDR$Sample_Type,"_","AIEIVDQALDR") 

#Infusion Data
ETDIGVTGGGQGK_light_DIF_FAIMS_summed <- rbind(ETDIGVTGGGQGK_light_summed, ETDIGVTGGGQGK_FAIMS_light_summed)

ETDIGVTGGGQGK_heavy_DIF_FAIMS_summed <- rbind(ETDIGVTGGGQGK_heavy_summed, ETDIGVTGGGQGK_FAIMS_heavy_summed)
names(ETDIGVTGGGQGK_heavy_DIF_FAIMS_summed) <- names(ETDIGVTGGGQGK_light_DIF_FAIMS_summed)

ETDIGVTGGGQGK_light_heavy_DIF_FAIMS_summed <- rbind(ETDIGVTGGGQGK_light_DIF_FAIMS_summed, ETDIGVTGGGQGK_heavy_DIF_FAIMS_summed)
ETDIGVTGGGQGK_light_heavy_DIF_FAIMS_summed$Sample  <- paste0(ETDIGVTGGGQGK_light_heavy_DIF_FAIMS_summed$Sample,"_", ETDIGVTGGGQGK_light_heavy_DIF_FAIMS_summed$IonMobility)


AIEIVDQALDR_light_DIF_FAIMS_summed <- rbind(AIEIVDQALDR_light_summed, AIEIVDQALDR_FAIMS_light_summed)

AIEIVDQALDR_heavy_DIF_FAIMS_summed <- rbind(AIEIVDQALDR_heavy_summed, AIEIVDQALDR_FAIMS_heavy_summed)
names(AIEIVDQALDR_heavy_DIF_FAIMS_summed) <- names(AIEIVDQALDR_light_DIF_FAIMS_summed)

AIEIVDQALDR_light_heavy_DIF_FAIMS_summed <- rbind(AIEIVDQALDR_light_DIF_FAIMS_summed, AIEIVDQALDR_heavy_DIF_FAIMS_summed)
AIEIVDQALDR_light_heavy_DIF_FAIMS_summed$Sample  <- paste0(AIEIVDQALDR_light_heavy_DIF_FAIMS_summed$Sample,"_", AIEIVDQALDR_light_heavy_DIF_FAIMS_summed$IonMobility)

#Infusion Ratio
ETDIGVTGGGQGK_DIF_ratio <- ETDIGVTGGGQGK_light_ratio[,1:7]
ETDIGVTGGGQGK_DIF_ratio$Ratio <- ETDIGVTGGGQGK_heavy_summed$MarkerIonsSummed/ETDIGVTGGGQGK_light_summed$MarkerIonsSummed
ETDIGVTGGGQGK_DIF_ratio$Sample <- paste0(ETDIGVTGGGQGK_DIF_ratio$Sample,"_",ETDIGVTGGGQGK_DIF_ratio$IonMobility)

ETDIGVTGGGQGK_FAIMS_ratio <- ETDIGVTGGGQGK_FAIMS_light_ratio[,1:7]
ETDIGVTGGGQGK_FAIMS_ratio$Ratio <- ETDIGVTGGGQGK_FAIMS_heavy_summed$MarkerIonsSummed/ETDIGVTGGGQGK_FAIMS_light_summed$MarkerIonsSummed
ETDIGVTGGGQGK_FAIMS_ratio$Sample <- paste0(ETDIGVTGGGQGK_FAIMS_ratio$Sample,"_",ETDIGVTGGGQGK_FAIMS_ratio$IonMobility)

AIEIVDQALDR_DIF_ratio <- AIEIVDQALDR_light_ratio[,1:7]
AIEIVDQALDR_DIF_ratio$Ratio <- AIEIVDQALDR_heavy_summed$MarkerIonsSummed/AIEIVDQALDR_light_summed$MarkerIonsSummed
AIEIVDQALDR_DIF_ratio$Sample <- paste0(AIEIVDQALDR_DIF_ratio$Sample, "_", AIEIVDQALDR_DIF_ratio$IonMobility)

AIEIVDQALDR_FAIMS_ratio <- AIEIVDQALDR_FAIMS_light_ratio[,1:7]
AIEIVDQALDR_FAIMS_ratio$Ratio <- AIEIVDQALDR_FAIMS_heavy_summed$MarkerIonsSummed/AIEIVDQALDR_FAIMS_light_summed$MarkerIonsSummed
AIEIVDQALDR_FAIMS_ratio$Sample <- paste0(AIEIVDQALDR_FAIMS_ratio$Sample,"_",AIEIVDQALDR_FAIMS_ratio$IonMobility)


#df <- ETDIGVTGGGQGK_light_heavy_DIF_FAIMS_summed
aggregate_sums <- function(df){
  
  aggregate_sum_ions <- aggregate(df$MarkerIonsSummed,
                                list(df$Sample), mean)
  
  aggregate_sum_ions$stdev <- aggregate(df$MarkerIonsSummed,
                                list(df$Sample), sd)[[2]]
  
  aggregate_sum_ions$log2Average <- log2(aggregate_sum_ions$x)
  
  aggregate_sum_ions$log2Stdev <- aggregate(df$MarkerIonsSummed,
                                list(df$Sample), function(x) sd(log2(x)))[[2]]
  aggregate_sum_ions$CV <- aggregate_sum_ions$stdev/aggregate_sum_ions$x*100
  
  colnames(aggregate_sum_ions) <- c("Sample", "Average_Sum", "Stdev_Sum", "Log2Average_Sum", "Stdev_Log2Sum", "%CV")
  
  # ggplot(aggregate_sum_ions, aes(Concentration, Log2Average_Sum))+
  # geom_point()
  
  return(aggregate_sum_ions)
}

df <- ETDIGVTGGGQGK_DIF_ratio
aggregate_ratio <- function(df){
  
  aggregate_sum_ions <- aggregate(df$Ratio,
                                list(df$Sample), mean)
  
  aggregate_sum_ions$stdev <- aggregate(df$Ratio,
                                list(df$Sample), sd)[[2]]
  
  aggregate_sum_ions$log2Average <- log2(aggregate_sum_ions$x)
  
  aggregate_sum_ions$log2Stdev <- aggregate(df$Ratio,
                                list(df$Sample), function(x) sd(log2(x)))[[2]]
  aggregate_sum_ions$CV <- aggregate_sum_ions$stdev/aggregate_sum_ions$x*100
  
  colnames(aggregate_sum_ions) <- c("Sample", "Average_Sum", "Stdev_Sum", "Log2Average_Sum", "Stdev_Log2Sum", "%CV")
  
  # ggplot(aggregate_sum_ions, aes(Concentration, Log2Average_Sum))+
  # geom_point()
  
  return(aggregate_sum_ions)
}

aggregate_sum_ETDIGVTGGGQGK <- aggregate_sums(ETDIGVTGGGQGK_light_heavy_DIF_FAIMS_summed)
aggregate_sum_AIEIVDQALDR <- aggregate_sums(AIEIVDQALDR_light_heavy_DIF_FAIMS_summed)

names(aggregate_AIEIVDQALDR) <- names(aggregate_sum_AIEIVDQALDR)
names(aggregate_ETDIGVTGGGQGK) <- names(aggregate_sum_ETDIGVTGGGQGK)


aggregate_ratio_ETDIGVTGGGQGK <- aggregate_ratio(ETDIGVTGGGQGK_DIF_ratio)
aggregate_ratio_FAIMS_ETDIGVTGGGQGK <- aggregate_ratio(ETDIGVTGGGQGK_FAIMS_ratio)

aggregate_ratio_AIEIVDQALDR <- aggregate_ratio(AIEIVDQALDR_DIF_ratio)
aggregate_ratio_FAIMS_AIEIVDQALDR <- aggregate_ratio(AIEIVDQALDR_FAIMS_ratio)

CV_LC_Infusion <- rbind(aggregate_ETDIGVTGGGQGK,aggregate_AIEIVDQALDR, aggregate_sum_ETDIGVTGGGQGK, aggregate_sum_AIEIVDQALDR, aggregate_ratio_ETDIGVTGGGQGK, aggregate_ratio_FAIMS_ETDIGVTGGGQGK, aggregate_ratio_AIEIVDQALDR,aggregate_ratio_FAIMS_AIEIVDQALDR)
CV_LC_Infusion <- CV_LC_Infusion[-grep("PRM", CV_LC_Infusion$Sample),]

Ion_mobility_infusion <- sub(".*ETDIGVTGGGQGK_", "", CV_LC_Infusion[grep("FAIMS", CV_LC_Infusion$Sample),1],"_")
Ion_mobility_infusion <- sub(".*AIEIVDQALDR_", "", Ion_mobility_infusion ,"_")



Type <-  c(rep("DDA",6), Ion_mobility_infusion)
CV_LC_Infusion$Type <- Type
CV_LC_Infusion$Type[grep("ratio", CV_LC_Infusion$Sample)] <- paste0(CV_LC_Infusion$Type[grep("ratio", CV_LC_Infusion$Sample)],"_","HeavyToLight")



peptide_Type_DDA <- paste0(sub(".*DDA_","", CV_LC_Infusion$Sample[1:6]),"_","DDA")
peptide_Type_Infusion <- paste0(sub("ISPG_","", CV_LC_Infusion$Sample[-c(1:6)]))
peptide_Type_Infusion <- paste0(sub("ISPH_","", peptide_Type_Infusion))
peptide_Type_Infusion <- paste0(sub("WT_","", peptide_Type_Infusion))
peptide_Type <- c(peptide_Type_DDA, peptide_Type_Infusion)
CV_LC_Infusion$Peptide_Type <- peptide_Type

#Separate dataframes with ratio calculation
CV_LC_Infusion_ratio <- CV_LC_Infusion[grep("ratio", CV_LC_Infusion$Sample),]
CV_LC_Infusion <- CV_LC_Infusion[-grep("ratio", CV_LC_Infusion$Sample),]


CV_LC_Infusion <- CV_LC_Infusion %>% mutate(Type = factor(Type, level = c("DDA", "no_FAIMS", "FAIMS")))

order_peptide_type <- factor(CV_LC_Infusion$Peptide_Type, levels = c("ETDIGVTGGGQGK_DDA","AIEIVDQALDR_DDA", "light_ETDIGVTGGGQGK_no_FAIMS","light_AIEIVDQALDR_no_FAIMS","heavy_ETDIGVTGGGQGK_no_FAIMS","heavy_AIEIVDQALDR_no_FAIMS","light_ETDIGVTGGGQGK_FAIMS","light_AIEIVDQALDR_FAIMS","heavy_ETDIGVTGGGQGK_FAIMS","heavy_AIEIVDQALDR_FAIMS"))

CV_LC_Infusion_ordered <- CV_LC_Infusion %>%
  mutate(Peptide_Type = factor(Peptide_Type, level = levels(order_peptide_type)))

Peptide <- sub("heavy_","", CV_LC_Infusion_ordered$Peptide_Type)
Peptide <- sub("light_","", Peptide)
Peptide <- sub("_DDA", "", Peptide)
Peptide <- sub("_no_FAIMS","", Peptide)
Peptide <- sub("_FAIMS", "", Peptide)

CV_LC_Infusion_ordered$Peptide <- factor(Peptide)

CV_LC_Infusion_ratio <- CV_LC_Infusion_ratio %>% mutate(Type = factor(Type, levels = c("no_FAIMS_HeavyToLight", "FAIMS_HeavyToLight")))
Peptide <- sub("ratio_","",CV_LC_Infusion_ratio$Peptide_Type)
Peptide <- sub("_no_FAIMS", "", Peptide)
Peptide <- sub("_FAIMS", "", Peptide)
CV_LC_Infusion_ratio$Peptide <- Peptide

p <- ggplot(CV_LC_Infusion_ordered, aes(x=Sample, y=`%CV`,size = Log2Average_Sum, fill = Peptide))+
  # geom_point(color="black",
  #       fill="#69b3a2",
  #       shape=22,
  #       alpha=0.5,
  #       size=6,
  #       stroke = 1)+
  geom_point( alpha=0.6, shape =21, color="black")+
  scale_size(range = c(5,10),name = "Log2(Average Intensity)")+
  scale_fill_manual(values = c("#C3DE79","#5ABCB2"))+
  theme_light()+
  facet_grid(~Type, scales = "free", space = "free")

p + theme(axis.text.x = element_text(angle = 50, hjust = 1)) + labs(title = "%CV across methods", y = "%CV", x= "")

p <- ggplot(CV_LC_Infusion_ordered, aes(x=Sample, y=`%CV`,size = Log2Average_Sum, fill = Peptide))+
  # geom_point(color="black",
  #       fill="#69b3a2",
  #       shape=22,
  #       alpha=0.5,
  #       size=6,
  #       stroke = 1)+
  geom_point( alpha=0.6, shape =21, color="black")+
  scale_size(range = c(5,10),name = "Log2(Average Intensity)")+
  scale_fill_manual(values = c("#C3DE79","#5ABCB2"))+
  theme_light()+
  facet_grid(~Type, scales = "free", space = "free")

p + theme(axis.text.x = element_text(angle = 50, hjust = 1)) + labs(title = "%CV across methods", y = "%CV", x= "")


p <- ggplot(CV_LC_Infusion_ratio, aes(x=Sample, y=`%CV`, fill = Peptide))+
  geom_point(size = 6, alpha=0.6, shape =21, color="black")+
  scale_fill_manual(values = c("#C3DE79","#5ABCB2"))+
  scale_y_continuous(breaks = seq(0,17,5), limit = c(0,18))+
  theme_light()+
  facet_grid(~Type, scales = "free", space = "free")
p + theme(axis.text.x = element_text(angle = 50, hjust = 1)) + labs(title = "%CV for computed ratios (heavy to light)", y = "%CV", x= "")

```

```{r,echo=FALSE}

select_peptides <- c("AIEIVDQALDR","ETDIGVTGGGQGK")
FC_specificPeptides_OE_ISPH_ISPG <- FC_allPeptides_OE_ISPH_ISPG[which(FC_allPeptides_OE_ISPH_ISPG$peptide %in% select_peptides),]

infusion <- peptides_DIF_FAIMS_combined[,c(6,7,9,11)]
names(infusion) <- c("Sample", "Analysis_Type", "Summed_ions", "FC")
LC <- FC_specificPeptides_OE_ISPH_ISPG[,c(4,5,9,10)]
LC <- LC[-grep("PRM", LC$Analysis_Type),]
rownames(LC) <- FC_specificPeptides_OE_ISPH_ISPG$Sample_Names[-grep("PRM", FC_specificPeptides_OE_ISPH_ISPG$Sample_Names)]
names(LC) <- c("Sample", "Analysis_Type", "Summed_ions", "FC")
method_comparison_Df <- rbind(LC, infusion)

method_comparison_Df <- method_comparison_Df %>%
  mutate(Analysis_Type = factor(Analysis_Type, level = c("DDA", "no_FAIMS", "FAIMS")))

p <- ggplot(method_comparison_Df, aes(Sample, log2(FC)), fill = as.factor(Analysis_Type))+
  geom_boxplot()+
  scale_fill_manual(values = c("#5ABCB2", "#C3DE79"))+
  scale_y_continuous(breaks = seq(0,6,1), limit = c(0,6))+
  theme_light()+
  facet_grid(~Analysis_Type, scales = "free", space = "free")

p + theme(axis.text.x = element_text(angle = 50, hjust = 1)) + labs(title = "Fold Change Over Expressed Strain to Wild Type", 
                                                                    subtitle = "Comparing methods",
                                                                    y = "Fold Change relative to Wild Type", x= "")
```

```{r,echo=FALSE}
FAIMS_Induction_ETDIGVTGGGQGKlight <- read.csv("P:/EAT_20190926_Zymomona/Zymo_TimeCourse/Infusions/FAIMS_halfdiluted/CompiledFragmentResults_ETDIGVTGGGQGK_FAIMS_infusion_2020SeptInduction_IsotopeDifferenceRecalculated.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

FAIMS_Induction_ETDIGVTGGGQGKheavy <- read.csv("P:/EAT_20190926_Zymomona/Zymo_TimeCourse/Infusions/FAIMS_halfdiluted/CompiledFragmentResults_ETDIGVTGGGQGKheavy_FAIMS_infusion_2020SeptInduction_IsotopeDifferenceRecalculated.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

FAIMS_Induction_AIEIVDQALDRlight <- read.csv("P:/EAT_20190926_Zymomona/Zymo_TimeCourse/Infusions/FAIMS_halfdiluted/CompiledFragmentResults_AIEIVDQALDR_FAIMS_infusion_2020SeptInduction_IsotopeDifferenceRecalculated.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

FAIMS_Induction_AIEIVDQALDRheavy <- read.csv("P:/EAT_20190926_Zymomona/Zymo_TimeCourse/Infusions/FAIMS_halfdiluted/CompiledFragmentResults_AIEIVDQALDRheavy_FAIMS_infusion_2020SeptInduction_IsotopeDifferenceRecalculated.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)
```


```{r, echo=FALSE}
Induction_ETDIGVTGGGQGKlight <- read.csv("P:/EAT_20190926_Zymomona/Zymo_TimeCourse/Infusions/NoFAIMS_infusions/muliplex/CompiledFragmentResults_ETDIGVTGGGQGK_infusion_2020SeptInduction_IsotopeDifferenceRecalculated.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

Induction_ETDIGVTGGGQGKheavy <- read.csv("P:/EAT_20190926_Zymomona/Zymo_TimeCourse/Infusions/NoFAIMS_infusions/muliplex/CompiledFragmentResults_ETDIGVTGGGQGKheavy_infusion_2020SeptInduction_IsotopeDifferenceRecalculated.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

Induction_AIEIVDQALDRlight <- read.csv("P:/EAT_20190926_Zymomona/Zymo_TimeCourse/Infusions/NoFAIMS_infusions/muliplex/CompiledFragmentResults_AIEIVDQALDR_infusion_2020SeptInduction_IsotopeDifferenceRecalculated.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

Induction_AIEIVDQALDRheavy <- read.csv("P:/EAT_20190926_Zymomona/Zymo_TimeCourse/Infusions/NoFAIMS_infusions/muliplex/CompiledFragmentResults_AIEIVDQALDRheavy_infusion_2020SeptInduction_IsotopeDifferenceRecalculated.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

```

Induction plotting is done!
```{r NOTFINISHED,echo=FALSE}
library(gtools)
  #df <- Induction_ETDIGVTGGGQGKlight
#df<- FAIMS_Induction_ETDIGVTGGGQGKlight
Induction_meta <- function(df){
  
  #Extract sample names and reformat
  RAW_Sample_names <- colnames(df[,-c(1:2)])
  Sample_names <- sub("X20200926_", "", RAW_Sample_names)
  Sample_names <- sub("X20200926","", Sample_names)
  Sample_names <- sub("X2020096_", "", Sample_names)
  
  Sample_names <- sub("X20200922_", "", Sample_names)
  Sample_names <- gsub("_", "-", Sample_names)
  
  
  Sample_meta <- as.data.frame(Sample_names) %>% separate(Sample_names, into = paste("V", 1:5, sep = "-"))
  
  if(length(grep("FAIMS",Sample_meta$`V-4`)) != 0){
        for(i in 1:nrow(Sample_meta)){
      if(length(grep("half",Sample_meta$`V-5`[i])) !=0){
          Sample_meta$`V-5`[i] <- Sample_meta$`V-4`[i]
      }
        }
    Sample_meta$RAW.file <- RAW_Sample_names
    Sample_meta <- Sample_meta[mixedorder(Sample_meta$`V-5`),]
    Sample_meta$`V-4` <- rep("FAIMS",length(Sample_meta$`V-4`))
    Sample_meta$Unique <- make.unique(as.character(Sample_meta$`V-5`),sep = "-")
    Sample_meta$`V-3` <- sub("point.*",".5", Sample_meta$`V-3`)
    
    #Sample_meta[which(Sample_meta$`V-3` == "3"),3] <- "30"
    
    Sample_Analysis <- paste0(Sample_meta$`V-1`, "-", Sample_meta$`V-4`)
    Sample_meta$Sample_Analysis <- Sample_Analysis
    Sample_meta$Sample_Analysis_Timepoint <- paste0(Sample_Analysis,"_",Sample_meta$`V-3`)
    
    colnames(Sample_meta) <- c("Strain", "Replicate", "Timepoint", "IonMobility", "Well", "Raw.File","UniqueWell", "Sample_Analysis", "Sample_Analysis_Timepoint")
  }else{
    Sample_meta$`V-4` <- rep("no_FAIMS",length(Sample_meta$`V-4`))
    Sample_meta$`V-3` <- as.numeric(sub("point.*",".5", Sample_meta$`V-3`))
    Sample_meta$RAW.file <- RAW_Sample_names
    Sample_Analysis <- paste0(Sample_meta$`V-1`, "-", Sample_meta$`V-4`)
    Sample_meta$`V-5` <- Sample_Analysis
    Sample_meta$Sample_Analysis_Timepoint <- paste0(Sample_Analysis,"_",Sample_meta$`V-3`)
    
    Sample_meta <- Sample_meta[order(Sample_meta[,1], Sample_meta[,3]),]
    
        colnames(Sample_meta) <- c("Strain", "Replicate", "Timepoint", "IonMobility", "Sample_Analysis","Raw.File", "Sample_Analysis_Timepoint")
  }

  

  return(Sample_meta)
}



# meta <- Induction_ETDIGVTGGGQGKlight_meta
# df <- Induction_ETDIGVTGGGQGKlight
Induction_formating_df <- function(meta,df){
  
  #Extract colmumns with precursor in it
  t_df <- data.frame(t(df[,-c(1:2)]))
  t_df$Raw.File <- rownames(t_df[,-c(1:2)])
  colnames(t_df) <- c(df[,1],"Raw.File")
  
  df_merge <- merge(meta, t_df, by.x = "Raw.File", by.y = "Raw.File")
  
  if(length(grep("no_FAIMS", meta$IonMobility)) !=0){
    df_merge_ordered<- df_merge[order(df_merge[,2], df_merge[,4]),]
  }else{
      df_merge_ordered <- df_merge[mixedorder(df_merge$Well),]
  }

  
  return(df_merge_ordered)
  
}

FAIMS_Induction_ETDIGVTGGGQGKlight_meta <- Induction_meta(FAIMS_Induction_ETDIGVTGGGQGKlight) 
FAIMS_Induction_ETDIGVTGGGQGKlight_ordered <- Induction_formating_df(FAIMS_Induction_ETDIGVTGGGQGKlight_meta, FAIMS_Induction_ETDIGVTGGGQGKlight)
  
df_ordered <- FAIMS_Induction_ETDIGVTGGGQGKlight_ordered
selective_ions <- c("y7","y8","y9")
summed_selectiveIons <- function(df_ordered,selective_ions){
  
  
  df_meta_Selectiveions <- df_ordered[,c(2:9,which(colnames(df_ordered) %in% selective_ions))]

  #Summed precursor 
  Summed_ions <- apply(df_meta_Selectiveions[,which(colnames(df_meta_Selectiveions) %in% selective_ions)], 1, sum)
  #Append Summed precursor to dataframe
  df_meta_Selectiveions$SummedIons <- Summed_ions
  df_meta_Selectiveions$Timepoint <- as.numeric(df_meta_Selectiveions$Timepoint)
    
  return(df_meta_Selectiveions)
}

df_heavy <- Induction_ETDIGVTGGGQGKheavy_ordered_selectiveIons
df_light <- Induction_ETDIGVTGGGQGKlight_ordered_selectiveIons
ratio_selectiveIons <- function(df_heavy, df_light){
  
  if(length(grep("no_FAIMS",df_heavy$IonMobility)) != 0){
          df_ratio <- df_heavy[,c(1:6)]
  df_ratio$Ratio <- df_light$SummedIons/df_heavy$SummedIons
  }else{
      df_ratio <- df_heavy[,c(1:8)]
  df_ratio$Ratio <- df_light$SummedIons/df_heavy$SummedIons
  }

  
  return(df_ratio)
  
}

```

FAIMS Induction
```{r,echo=FALSE}
FAIMS_Induction_ETDIGVTGGGQGKlight_meta <- Induction_meta(FAIMS_Induction_ETDIGVTGGGQGKlight) 
FAIMS_Induction_ETDIGVTGGGQGKlight_ordered <- Induction_formating_df(FAIMS_Induction_ETDIGVTGGGQGKlight_meta, FAIMS_Induction_ETDIGVTGGGQGKlight)

FAIMS_Induction_ETDIGVTGGGQGKlight_ordered_selectiveIons <- summed_selectiveIons(FAIMS_Induction_ETDIGVTGGGQGKlight_ordered,c("y7","y8","y9"))

ggplot(FAIMS_Induction_ETDIGVTGGGQGKlight_ordered_selectiveIons, aes(x=Timepoint, y=SummedIons, color = Strain)) +
  geom_jitter(stat = "identity", position = "jitter")

FAIMS_Induction_ETDIGVTGGGQGKheavy_meta <- Induction_meta(FAIMS_Induction_ETDIGVTGGGQGKheavy) 
FAIMS_Induction_ETDIGVTGGGQGKheavy_ordered <- Induction_formating_df(FAIMS_Induction_ETDIGVTGGGQGKheavy_meta, FAIMS_Induction_ETDIGVTGGGQGKheavy)

FAIMS_Induction_ETDIGVTGGGQGKheavy_ordered_selectiveIons <- summed_selectiveIons(FAIMS_Induction_ETDIGVTGGGQGKheavy_ordered,c("y7","y8","y9"))

FAIMS_Induction_ETDIGVTGGGQGK_ratio <- ratio_selectiveIons(FAIMS_Induction_ETDIGVTGGGQGKheavy_ordered_selectiveIons,FAIMS_Induction_ETDIGVTGGGQGKlight_ordered_selectiveIons)


p <- ggplot(FAIMS_Induction_ETDIGVTGGGQGK_ratio[-grep("-1",FAIMS_Induction_ETDIGVTGGGQGK_ratio$UniqueWell),], aes(x=Timepoint, y=Ratio, color = as.factor(Strain))) +
    geom_jitter(stat = "identity", position = "jitter", size = 2.75, shape = 19, alpha = 0.6)+
  scale_y_continuous(breaks = seq(0,5,1), limit = c(0,5))+
  scale_color_manual(values = c("#5ABCB2", "#C3DE79","#A394DD"))+
  theme_light()
p + labs(title = "Induction over 180 min",subtitle = "ETDIGVTGGGQGK Ratio - light to heavy", y = "light to heavy ratio", x = "time (min)")

```


```{r,echo=FALSE}
FAIMS_Induction_AIEIVDQALDRlight_meta <- Induction_meta(FAIMS_Induction_AIEIVDQALDRlight) 
FAIMS_Induction_AIEIVDQALDRlight_ordered <- Induction_formating_df(FAIMS_Induction_AIEIVDQALDRlight_meta, FAIMS_Induction_AIEIVDQALDRlight)

FAIMS_Induction_AIEIVDQALDRlight_ordered_selectiveIons <- summed_selectiveIons(FAIMS_Induction_AIEIVDQALDRlight_ordered,c("y7","y8","y9"))

ggplot(FAIMS_Induction_AIEIVDQALDRlight_ordered_selectiveIons, aes(x=Timepoint, y=SummedIons, color = as.factor(Strain))) +
    geom_jitter(stat = "identity", position = "jitter", size = 2, shape = 19, alpha = 0.7)+
  scale_color_manual(values = c("#5ABCB2", "#C3DE79","#A394DD"))+
  theme_light()

FAIMS_Induction_AIEIVDQALDRheavy_meta <- Induction_meta(FAIMS_Induction_AIEIVDQALDRheavy) 
FAIMS_Induction_AIEIVDQALDRheavy_ordered <- Induction_formating_df(FAIMS_Induction_AIEIVDQALDRheavy_meta, FAIMS_Induction_AIEIVDQALDRheavy)

FAIMS_Induction_AIEIVDQALDRheavy_ordered_selectiveIons <- summed_selectiveIons(FAIMS_Induction_AIEIVDQALDRheavy_ordered,c("y7","y8","y9"))

FAIMS_Induction_AIEIVDQALDR_ratio <- ratio_selectiveIons(FAIMS_Induction_AIEIVDQALDRheavy_ordered_selectiveIons,FAIMS_Induction_AIEIVDQALDRlight_ordered_selectiveIons)

p <- ggplot(FAIMS_Induction_AIEIVDQALDR_ratio[-grep("-1",FAIMS_Induction_AIEIVDQALDR_ratio$UniqueWell),], aes(x=Timepoint, y=Ratio, color = as.factor(Strain))) +
  scale_y_continuous(breaks = seq(0,5,1), limit = c(0,5))+
  geom_jitter(stat = "identity", position = "jitter", size = 2.75, shape = 19, alpha = 0.6)+
  scale_color_manual(values = c("#5ABCB2", "#C3DE79","#A394DD"))+
  theme_light()

 p+labs(title = "Induction over 180 min",subtitle = "AIEIVDQALDR Ratio - light to heavy", y = "light to heavy ratio", x = "time (min)")

```


```{r,echo=FALSE}
Induction_ETDIGVTGGGQGKlight_meta <- Induction_meta(Induction_ETDIGVTGGGQGKlight) 
Induction_ETDIGVTGGGQGKlight_ordered <- Induction_formating_df(Induction_ETDIGVTGGGQGKlight_meta, Induction_ETDIGVTGGGQGKlight)

Induction_ETDIGVTGGGQGKlight_ordered_selectiveIons <- summed_selectiveIons(Induction_ETDIGVTGGGQGKlight_ordered,c("y7","y8","y9"))


ggplot(Induction_ETDIGVTGGGQGKlight_ordered_selectiveIons, aes(x=Timepoint, y=SummedIons, color = Strain)) +
  geom_jitter(stat = "identity", position = "jitter")

Induction_ETDIGVTGGGQGKheavy_meta <- Induction_meta(Induction_ETDIGVTGGGQGKheavy) 
Induction_ETDIGVTGGGQGKheavy_ordered <- Induction_formating_df(Induction_ETDIGVTGGGQGKheavy_meta, Induction_ETDIGVTGGGQGKheavy)

Induction_ETDIGVTGGGQGKheavy_ordered_selectiveIons <- summed_selectiveIons(Induction_ETDIGVTGGGQGKheavy_ordered,c("y7","y8","y9"))


Induction_ETDIGVTGGGQGK_ratio <- ratio_selectiveIons(Induction_ETDIGVTGGGQGKheavy_ordered_selectiveIons,Induction_ETDIGVTGGGQGKlight_ordered_selectiveIons)


p <- ggplot(Induction_ETDIGVTGGGQGK_ratio, aes(x=Timepoint, y=Ratio, color = as.factor(Strain))) +
    geom_jitter(stat = "identity", position = "jitter", size = 2.75, shape = 19, alpha = 0.6)+
  scale_y_continuous(breaks = seq(0,5,1), limit = c(0,5))+
  scale_color_manual(values = c("#5ABCB2", "#C3DE79","#A394DD"))+
  theme_light()
p + labs(title = "Induction over 180 min",subtitle = "no FAIMS ETDIGVTGGGQGK Ratio - light to heavy", y = "light to heavy ratio", x = "time (min)")

```


```{r,echo=FALSE}
Induction_AIEIVDQALDRlight_meta <- Induction_meta(Induction_AIEIVDQALDRlight) 
Induction_AIEIVDQALDRlight_ordered <- Induction_formating_df(Induction_AIEIVDQALDRlight_meta, Induction_AIEIVDQALDRlight)

Induction_AIEIVDQALDRlight_ordered_selectiveIons <- summed_selectiveIons(Induction_AIEIVDQALDRlight_ordered,c("y7","y8","y9"))


ggplot(Induction_AIEIVDQALDRlight_ordered_selectiveIons, aes(x=Timepoint, y=SummedIons, color = Strain)) +
  geom_jitter(stat = "identity", position = "jitter")

Induction_AIEIVDQALDRheavy_meta <- Induction_meta(Induction_AIEIVDQALDRheavy) 
Induction_AIEIVDQALDRheavy_ordered <- Induction_formating_df(Induction_AIEIVDQALDRheavy_meta, Induction_AIEIVDQALDRheavy)

Induction_AIEIVDQALDRheavy_ordered_selectiveIons <- summed_selectiveIons(Induction_AIEIVDQALDRheavy_ordered,c("y7","y8","y9"))


Induction_AIEIVDQALDR_ratio <- ratio_selectiveIons(Induction_AIEIVDQALDRheavy_ordered_selectiveIons,Induction_AIEIVDQALDRlight_ordered_selectiveIons)


p <- ggplot(Induction_AIEIVDQALDR_ratio, aes(x=Timepoint, y=Ratio, color = as.factor(Strain))) +
    geom_jitter(stat = "identity", position = "jitter", size = 2.75, shape = 19, alpha = 0.6)+
  scale_y_continuous(breaks = seq(0,5,1), limit = c(0,5))+
  scale_color_manual(values = c("#5ABCB2", "#C3DE79","#A394DD"))+
  theme_light()
p + labs(title = "Induction over 180 min",subtitle = "no FAIMS AIEIVDQALDR Ratio - light to heavy", y = "light to heavy ratio", x = "time (min)")

```


```{r LoadSpiked_Matrx, echo=FALSE}
SpikeMatrixLadder_DIF_ETDIGVTGGGQGKlight <- read.csv("P:/EAT_20190926_Zymomona/Zymo_TimeCourse/Infusions/SpikedMatrixLadder_DirectInfusion/MultiPlexReplicates/CompiledFragmentResults_ETDIGVTGGGQGK_SpikedMatrix_Replicates_IsotopeDifferenceRecalculated.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

SpikeMatrixLadder_DIF_ETDIGVTGGGQGKheavy <- read.csv("P:/EAT_20190926_Zymomona/Zymo_TimeCourse/Infusions/SpikedMatrixLadder_DirectInfusion/MultiPlexReplicates/CompiledFragmentResults_ETDIGVTGGGQGKheavy_SpikedMatrix_Replicates_IsotopeDifferenceRecalculated.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

SpikeMatrixLadder_DIF_AIEIVDQALDRlight <- read.csv("P:/EAT_20190926_Zymomona/Zymo_TimeCourse/Infusions/SpikedMatrixLadder_DirectInfusion/MultiPlexReplicates/CompiledFragmentResults_AIEIVDQALDR_DirectInfusion_SpikedMatrix_Replicates_IsotopeDifferenceRecalculated.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

SpikeMatrixLadder_DIF_AIEIVDQALDRheavy <- read.csv("P:/EAT_20190926_Zymomona/Zymo_TimeCourse/Infusions/SpikedMatrixLadder_DirectInfusion/MultiPlexReplicates/CompiledFragmentResults_AIEIVDQALDRheavy_DirectInfusion_SpikedMatrix_Replicates_IsotopeDifferenceRecalculated.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

### FAIMS 

SpikeMatrixLadder_FAIMS_ETDIGVTGGGQGKlight <- read.csv("P:/EAT_20190926_Zymomona/Zymo_TimeCourse/Infusions/SpikedMatrixLadder_FAIMS/MultiPlexReplicates/CompiledFragmentResults_ETDIGVTGGGQGK_FAIMS_SpikedMatrix_Replicates_IsotopeDifferenceRecalculated.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

SpikeMatrixLadder_FAIMS_ETDIGVTGGGQGKheavy <- read.csv("P:/EAT_20190926_Zymomona/Zymo_TimeCourse/Infusions/SpikedMatrixLadder_FAIMS/MultiPlexReplicates/CompiledFragmentResults_ETDIGVTGGGQGKheavy_FAIMS_SpikedMatrix_Replicates_IsotopeDifferenceRecalculated.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

SpikeMatrixLadder_FAIMS_AIEIVDQALDRlight <- read.csv("P:/EAT_20190926_Zymomona/Zymo_TimeCourse/Infusions/SpikedMatrixLadder_FAIMS/MultiPlexReplicates/CompiledFragmentResults_AIEIVDQALDR_FAIMS_DirectInfusion_SpikedMatrix_Replicates_IsotopeDifferenceRecalculated.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)

SpikeMatrixLadder_FAIMS_AIEIVDQALDRheavy <- read.csv("P:/EAT_20190926_Zymomona/Zymo_TimeCourse/Infusions/SpikedMatrixLadder_FAIMS/MultiPlexReplicates/CompiledFragmentResults_AIEIVDQALDRheavy_FAIMS_DirectInfusion_SpikedMatrix_Replicates_IsotopeDifferenceRecalculated.csv", header = TRUE, sep = ",", stringsAsFactors = FALSE)


```


```{r SpikedMatriix_Formatting ,echo=FALSE}
df <- SpikeMatrixLadder_FAIMS_ETDIGVTGGGQGKheavy
target_ions <- c("y7", "y8", "y9")

Induction_Summed_precusor <- function(df, target_ions){
  
  #Extract sample names and reformat
  RAW_Sample_names <- colnames(df[,-c(1:2)])
  
    for(i in 1:length(RAW_Sample_names)){
    
    if(length(grep("2020", RAW_Sample_names[i])) ==!0){
      replicate_number <- sub(".*Multiplex","",RAW_Sample_names[i])
      replicate_number <- sub("_.*", "", replicate_number)
      reinject_name <- paste0("Multiplex","reinject", replicate_number)
      RAW_Sample_names[i] <- sub("Multiplex.*",reinject_name, RAW_Sample_names[i])
      
    }
    }

  Concentration <- sub("_spiked.*", "", RAW_Sample_names)
  Concentration <- sub("X", "", Concentration)
  Concentration <- sub("_FAIMS", "", Concentration)
  #Concentration <- gsub('.{1}$', '', Concentration)
  Concentration <- as.numeric(sub("_", ".", Concentration))
  
  MultiPlexReplicate <- sub(".*Matrix_", "", RAW_Sample_names)
  MultiPlexReplicate <- sub(".raw", "", MultiPlexReplicate)
  MultiPlexReplicate <- sub("Multiplex","", MultiPlexReplicate)
  
  Sample_meta <- data.frame(RAW_Sample_names, Concentration, MultiPlexReplicate)
  
  df_totalIons_sum <- data.frame(Sample_meta,apply(df[,-c(1:2)],2,sum),
                            apply(df[which(df$Mass.Feature %in% target_ions),-c(1:2)],2,sum))
  
  df_totalIons_sum_ordered <- df_totalIons_sum[order(df_totalIons_sum$Concentration),]
  
  # df_totalIons_sum_ordered <- df_totalIons_sum %>%
  # mutate(Concentttration = factor(Concentration, level = unique(df_totalIons_sum$Concentration)))
  return(df_totalIons_sum_ordered)
  
}
  
Summed_SpikeMatrixLadder_ETDIGVTGGGQGKlight <-  Induction_Summed_precusor(SpikeMatrixLadder_DIF_ETDIGVTGGGQGKlight,c("y7", "y8", "y9"))

Summed_SpikeMatrixLadder_ETDIGVTGGGQGKheavy <-  Induction_Summed_precusor(SpikeMatrixLadder_DIF_ETDIGVTGGGQGKheavy,c("y7", "y8", "y9"))

Summed_SpikeMatrixLadder_AIEIVDQALDRlight <-  Induction_Summed_precusor(SpikeMatrixLadder_DIF_AIEIVDQALDRlight,c("y7", "y8", "y9"))

Summed_SpikeMatrixLadder_AIEIVDQALDRheavy <-  Induction_Summed_precusor(SpikeMatrixLadder_DIF_AIEIVDQALDRheavy,c("y7", "y8", "y9"))

### FAIMS
Summed_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKlight <-  Induction_Summed_precusor(SpikeMatrixLadder_FAIMS_ETDIGVTGGGQGKlight ,c("y7", "y8", "y9"))
Summed_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKlight$RepConcentration <- paste0(Summed_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKlight$Concentration,gsub('.{1}$','',Summed_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKlight$MultiPlexReplicate))

Summed_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKheavy <-  Induction_Summed_precusor(SpikeMatrixLadder_FAIMS_ETDIGVTGGGQGKheavy,c("y7", "y8", "y9"))
Summed_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKheavy$RepConcentration <- paste0(Summed_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKheavy$Concentration,gsub('.{1}$','',Summed_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKheavy$MultiPlexReplicate))

 Summed_FAIMS_SpikeMatrixLadder_AIEIVDQALDRlight <-  Induction_Summed_precusor(SpikeMatrixLadder_FAIMS_AIEIVDQALDRlight ,c("y7", "y8", "y9"))
Summed_FAIMS_SpikeMatrixLadder_AIEIVDQALDRlight$RepConcentration <- paste0(Summed_FAIMS_SpikeMatrixLadder_AIEIVDQALDRlight$Concentration,gsub('.{1}$','',Summed_FAIMS_SpikeMatrixLadder_AIEIVDQALDRlight$MultiPlexReplicate))

Summed_FAIMS_SpikeMatrixLadder_AIEIVDQALDRheavy <-  Induction_Summed_precusor(SpikeMatrixLadder_FAIMS_AIEIVDQALDRheavy,c("y7", "y8", "y9"))
Summed_FAIMS_SpikeMatrixLadder_AIEIVDQALDRheavy$RepConcentration <- paste0(Summed_FAIMS_SpikeMatrixLadder_AIEIVDQALDRheavy$Concentration,gsub('.{1}$','',Summed_FAIMS_SpikeMatrixLadder_AIEIVDQALDRheavy$MultiPlexReplicate))


```


```{r,echo=FALSE}

  df<- Summed_SpikeMatrixLadder_ETDIGVTGGGQGKheavy
  WhichIons <- "Select"

aggregate_ions <- function(df, WhichIons){
  
  colnames(df) <- c(colnames(df)[1:3], "All", "Select")
  
  aggregate_sum_ions <- aggregate(df[,which(colnames(df) == WhichIons)],
                                list(df$Concentration), mean)
  
  aggregate_sum_ions$stdev <- aggregate(df[,which(colnames(df) == WhichIons)],
                                list(df$Concentration), sd)[[2]]
  
  aggregate_sum_ions$log2Average <- log2(aggregate_sum_ions$x)
  
  aggregate_sum_ions$log2Stdev <- aggregate(df[,which(colnames(df) == WhichIons)],
                                list(df$Concentration), function(x) sd(log2(x)))[[2]]
  aggregate_sum_ions$CV <- aggregate_sum_ions$stdev/aggregate_sum_ions$x*100
  
  colnames(aggregate_sum_ions) <- c("Concentration", "Average_Sum", "Stdev_Sum", "Log2Average_Sum", "Stdev_Log2Sum", "%CV")
  
  # ggplot(aggregate_sum_ions, aes(Concentration, Log2Average_Sum))+
  # geom_point()
  
  return(aggregate_sum_ions)
}

  df<- Summed_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKheavy
  WhichIons <- "Select"

Replicate_injection_aggregate_ions <- function(df, WhichIons){
  
  colnames(df) <- c(colnames(df)[1:3], "All", "Select","RepConcentration")
  
  aggregate_sum_ions <- aggregate(df[,which(colnames(df) == WhichIons)],
                                list(df$RepConcentration), mean)
  
  aggregate_sum_ions$stdev <- aggregate(df[,which(colnames(df) == WhichIons)],
                                list(df$RepConcentration), sd)[[2]]
  
  aggregate_sum_ions$log2Average <- log2(aggregate_sum_ions$x)
  
  aggregate_sum_ions$log2Stdev <- aggregate(df[,which(colnames(df) == WhichIons)],
                                list(df$RepConcentration), function(x) sd(log2(x)))[[2]]
  aggregate_sum_ions$CV <- aggregate_sum_ions$stdev/aggregate_sum_ions$x*100
  
  colnames(aggregate_sum_ions) <- c("RepConcentration", "Average_Sum", "Stdev_Sum", "Log2Average_Sum", "Stdev_Log2Sum", "%CV")
  
  aggregate_sum_ions$Concentration <- as.numeric(sub("reinject", "", aggregate_sum_ions$RepConcentration))
  
  aggregate_sum_ions_ordered <- aggregate_sum_ions[order(aggregate_sum_ions$Concentration),]
  
  # ggplot(aggregate_sum_ions, aes(Concentration, Log2Average_Sum))+
  # geom_point()
  
  return(aggregate_sum_ions_ordered)
}

df_all <- All_SpikeMatrixLadder_ETDIGVTGGGQGKlight
df_select <- Select_SpikeMatrixLadder_ETDIGVTGGGQGKlight

merge_spiked <- function(df_all, df_select){
  df_all$IonsMerged <- rep("All", nrow(df_all))
  df_select$IonsMerged <- rep("Select", nrow(df_all))
  
  df_merged <- rbind(df_all, df_select)
}


```


```{r SpiikedMatrix_ETD , echo=FALSE}

All_SpikeMatrixLadder_ETDIGVTGGGQGKlight <- aggregate_ions(Summed_SpikeMatrixLadder_ETDIGVTGGGQGKlight, "All")
Select_SpikeMatrixLadder_ETDIGVTGGGQGKlight <- aggregate_ions(Summed_SpikeMatrixLadder_ETDIGVTGGGQGKlight, "Select")
Merged_SpikeMatrixLadder_ETDIGVTGGGQGKlight <- merge_spiked(All_SpikeMatrixLadder_ETDIGVTGGGQGKlight, Select_SpikeMatrixLadder_ETDIGVTGGGQGKlight)


type.colors = as.numeric(factor(Merged_SpikeMatrixLadder_ETDIGVTGGGQGKlight$IonsMerged))
ggplot(Merged_SpikeMatrixLadder_ETDIGVTGGGQGKlight, aes(Concentration, Average_Sum, color=IonsMerged)) +
  geom_point()+
  geom_line()+
  theme_light() + 
  labs(title = "Spiked Matrix Curve - ETDIGVTGGGQGK light", subtitle = "Average Inttensity Across sample types in triplicate",
                                                                    y = "Summed Transitioin Intensity")


All_SpikeMatrixLadder_ETDIGVTGGGQGKheavy <- aggregate_ions(Summed_SpikeMatrixLadder_ETDIGVTGGGQGKheavy, "All")
Select_SpikeMatrixLadder_ETDIGVTGGGQGKheavy <- aggregate_ions(Summed_SpikeMatrixLadder_ETDIGVTGGGQGKheavy, "Select")
Merged_SpikeMatrixLadder_ETDIGVTGGGQGKheavy <- merge_spiked(All_SpikeMatrixLadder_ETDIGVTGGGQGKheavy, Select_SpikeMatrixLadder_ETDIGVTGGGQGKheavy)

type.colors = as.numeric(factor(Merged_SpikeMatrixLadder_ETDIGVTGGGQGKheavy$IonsMerged))
ggplot(Merged_SpikeMatrixLadder_ETDIGVTGGGQGKheavy, aes(Concentration, Average_Sum, color=IonsMerged)) +
  geom_point()+
  geom_line()+
  theme_light() + 
  labs(title = "Spiked Matrix Curve - ETDIGVTGGGQGK heavy", subtitle = "Average Inttensity Across sample types in triplicate",
                                                                    y = "Summed Transitioin Intensity")

All_SpikeMatrixLadder_AIEIVDQALDRlight <- aggregate_ions(Summed_SpikeMatrixLadder_AIEIVDQALDRlight, "All")
Select_SpikeMatrixLadder_AIEIVDQALDRlight <- aggregate_ions(Summed_SpikeMatrixLadder_AIEIVDQALDRlight, "Select")

All_SpikeMatrixLadder_AIEIVDQALDRheavy <- aggregate_ions(Summed_SpikeMatrixLadder_AIEIVDQALDRheavy, "All")
Select_SpikeMatrixLadder_AIEIVDQALDRheavy <- aggregate_ions(Summed_SpikeMatrixLadder_AIEIVDQALDRheavy, "Select")

#FAIMS

All_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKlight <- Replicate_injection_aggregate_ions(Summed_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKlight, "All")
Select_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKlight <- Replicate_injection_aggregate_ions(Summed_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKlight, "Select")
Merged_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKlight <- merge_spiked(All_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKlight, Select_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKlight)


type.colors = as.numeric(factor(Merged_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKlight$IonsMerged))
ggplot(Merged_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKlight, aes(Concentration, Average_Sum, color=IonsMerged)) +
  geom_point()+
  geom_line()+
  theme_light() + 
  labs(title = "Spiked Matrix Curve - ETDIGVTGGGQGK heavy", subtitle = "Average Inttensity Across sample types in triplicate",
                                                                    y = "Summed Transitioin Intensity")

All_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKheavy <- Replicate_injection_aggregate_ions(Summed_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKheavy, "All")
Select_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKheavy <- Replicate_injection_aggregate_ions(Summed_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKheavy, "Select")
Merged_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKheavy <- merge_spiked(All_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKheavy, Select_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKheavy)


  type.colors = as.numeric(factor(Merged_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKheavy$IonsMerged))
ggplot(Merged_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKheavy, aes(Concentration, Average_Sum, color=IonsMerged)) +
  geom_point()+
  geom_line()+
  theme_light() + 
  labs(title = "Spiked Matrix Curve - ETDIGVTGGGQGK heavy", subtitle = "Average Inttensity Across sample types in triplicate",
                                                                    y = "Summed Transitioin Intensity")

ggplot(Select_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKheavy, aes(Concentration, Average_Sum)) +
  geom_point()+
  theme_light() + 
  labs(title = "Spiked Matrix Curve - ETDIGVTGGGQGK heavy", subtitle = "Average Inttensity Across sample types in triplicate",
                                                                    y = "Summed Transitioin Intensity")

All_FAIMS_SpikeMatrixLadder_AIEIVDQALDRlight <- Replicate_injection_aggregate_ions(Summed_FAIMS_SpikeMatrixLadder_AIEIVDQALDRlight, "All")
Select_SpikeMatrixLadder_AIEIVDQALDRlight <- Replicate_injection_aggregate_ions(Summed_FAIMS_SpikeMatrixLadder_AIEIVDQALDRlight, "Select")

All_FAIMS_SpikeMatrixLadder_AIEIVDQALDRheavy <- Replicate_injection_aggregate_ions(Summed_FAIMS_SpikeMatrixLadder_AIEIVDQALDRheavy, "All")
Select_FAIMS_SpikeMatrixLadder_AIEIVDQALDRheavy <- Replicate_injection_aggregate_ions(Summed_FAIMS_SpikeMatrixLadder_AIEIVDQALDRheavy, "Select")

```

```{r,echo=FALSE}

# df_light <- Summed_SpikeMatrixLadder_ETDIGVTGGGQGKlight
# df_heavy <- Summed_SpikeMatrixLadder_ETDIGVTGGGQGKheavy
# WhichIons <- "All"

ratio_aggregate <- function(df_light, df_heavy, WhichIons){
  
  colnames(df_light) <- c(colnames(df_light[,1:3]), "All", "Select")
  colnames(df_heavy) <- c(colnames(df_heavy[,1:3]), "All", "Select")
  
  ratio <- df_heavy[,which(colnames(df_heavy) == WhichIons)]/df_light[,which(colnames(df_light) == WhichIons)]
  
  df_ratio <- data.frame(df_light$Concentration, ratio)
  
  aggregate_sum_ions <- aggregate(df_ratio$ratio,
                                list(df_ratio$df_light.Concentration), mean)
  
  aggregate_sum_ions$stdev <- aggregate(df_ratio$ratio,
                                list(df_ratio$df_light.Concentration), sd)[[2]]

  aggregate_sum_ions$CV <- aggregate_sum_ions$stdev/aggregate_sum_ions$x*100
  
  return(aggregate_sum_ions)
}

# df_light <- Summed_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKlight
# df_heavy <- Summed_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKheavy
# WhichIons <- "All"

Repliciate_ratio_aggregate <- function(df_light, df_heavy, WhichIons){
  
  colnames(df_light) <- c(colnames(df_light[,1:3]), "All", "Select", "RepConcentration")
  colnames(df_heavy) <- c(colnames(df_heavy[,1:3]), "All", "Select", "RepConcentration")
  
  ratio <- df_heavy[,which(colnames(df_heavy) == WhichIons)]/df_light[,which(colnames(df_light) == WhichIons)]
  
  df_ratio <- data.frame(df_light$Concentration, ratio)
  
  aggregate_sum_ions <- aggregate(df_ratio$ratio,
                                list(df_ratio$df_light.Concentration), mean)
  
  aggregate_sum_ions$stdev <- aggregate(df_ratio$ratio,
                                list(df_ratio$df_light.Concentration), sd)[[2]]

  aggregate_sum_ions$CV <- aggregate_sum_ions$stdev/aggregate_sum_ions$x*100
  aggregate_sum_ions$Concentration <- as.numeric(sub("reinject", "", aggregate_sum_ions$Group.1))
  
  aggregate_sum_ions_ordered <- aggregate_sum_ions[order(aggregate_sum_ions$Concentration),]
  
  return(aggregate_sum_ions_ordered)
}

```

```{r, echo=FALSE}

Ratio_SpikeMatrixLadder_ETDIGVTGGGQGK_All <- ratio_aggregate(Summed_SpikeMatrixLadder_ETDIGVTGGGQGKlight,Summed_SpikeMatrixLadder_ETDIGVTGGGQGKheavy,"All")

Ratio_SpikeMatrixLadder_ETDIGVTGGGQGK_Select <- ratio_aggregate(Summed_SpikeMatrixLadder_ETDIGVTGGGQGKlight,Summed_SpikeMatrixLadder_ETDIGVTGGGQGKheavy,"Select")


Ratio_SpikeMatrixLadder_AIEIVDQALDR_All <- ratio_aggregate(Summed_SpikeMatrixLadder_AIEIVDQALDRlight,Summed_SpikeMatrixLadder_AIEIVDQALDRheavy,"All")

Ratio_SpikeMatrixLadder_AIEIVDQALDR_Select <- ratio_aggregate(Summed_SpikeMatrixLadder_AIEIVDQALDRlight,Summed_SpikeMatrixLadder_AIEIVDQALDRheavy,"Select")

# FAIMS
Ratio_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGK_All <- Repliciate_ratio_aggregate(Summed_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKlight,Summed_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKheavy,"All")

Ratio_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGK_All_ordered <- Ratio_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGK_All %>%
  mutate(Group.1 = factor(Group.1, level = Ratio_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGK_All$Group.1))

Ratio_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGK_Select <- Repliciate_ratio_aggregate(Summed_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKlight,Summed_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKheavy,"Select")



Ratio_FAIMS_SpikeMatrixLadder_AIEIVDQALDR_All <- Repliciate_ratio_aggregate(Summed_FAIMS_SpikeMatrixLadder_AIEIVDQALDRlight,Summed_FAIMS_SpikeMatrixLadder_AIEIVDQALDRheavy,"All")

Ratio_FAIMS_SpikeMatrixLadder_AIEIVDQALDR_Select <- Repliciate_ratio_aggregate(Summed_FAIMS_SpikeMatrixLadder_AIEIVDQALDRlight,Summed_FAIMS_SpikeMatrixLadder_AIEIVDQALDRheavy,"Select")

```


```{r, echo=FALSE}
Ratio_SpikeMatrixLadder_ETDIGVTGGGQGK_All$IonMobility <- rep("noFAIMS", nrow(Ratio_SpikeMatrixLadder_ETDIGVTGGGQGK_All))
Ratio_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGK_All$IonMobility <- rep("FAIMS", nrow(Ratio_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGK_All))

Combined_Ratio_SpikeMatrixLadder_ETDIGVTGGGQGK_All <- rbind(Ratio_SpikeMatrixLadder_ETDIGVTGGGQGK_All,Ratio_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGK_All[,-5])
Combined_Ratio_SpikeMatrixLadder_ETDIGVTGGGQGK_All$Concentration <- c(Ratio_SpikeMatrixLadder_ETDIGVTGGGQGK_All$Group.1,Ratio_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGK_All$Concentration)
Combined_Ratio_SpikeMatrixLadder_ETDIGVTGGGQGK_All <- Combined_Ratio_SpikeMatrixLadder_ETDIGVTGGGQGK_All[order(Combined_Ratio_SpikeMatrixLadder_ETDIGVTGGGQGK_All$Concentration),]

Combined_Ratio_SpikeMatrixLadder_ETDIGVTGGGQGK_All$Type <- paste0(Combined_Ratio_SpikeMatrixLadder_ETDIGVTGGGQGK_All$Group.1, Combined_Ratio_SpikeMatrixLadder_ETDIGVTGGGQGK_All$IonMobility)

order_concentration <- factor(Combined_Ratio_SpikeMatrixLadder_ETDIGVTGGGQGK_All$Group.1, levels = c("15.625", "31.25", "62.5", "125", "125reinject", 
                                                                                                "250", "250reinject", "500", "500reinject"))


Combined_Ratio_SpikeMatrixLadder_ETDIGVTGGGQGK_All_ordered <- Combined_Ratio_SpikeMatrixLadder_ETDIGVTGGGQGK_All %>%
  mutate(Group.1 = factor(Group.1, level = levels(order_concentration)))

fitlm_ETDIGVTGGGQGK_noFAIMS <- lm(x ~ Concentration, data = Combined_Ratio_SpikeMatrixLadder_ETDIGVTGGGQGK_All_ordered[grep("noFAIMS",Combined_Ratio_SpikeMatrixLadder_ETDIGVTGGGQGK_All_ordered$Type),])
fitlm_ETDIGVTGGGQGK_FAIMS <- lm(x ~ Concentration, data = Combined_Ratio_SpikeMatrixLadder_ETDIGVTGGGQGK_All_ordered[-grep("noFAIMS",Combined_Ratio_SpikeMatrixLadder_ETDIGVTGGGQGK_All_ordered$Type),])

  
predict_ETDIGVTGGGQK <- as.data.frame(cbind(c(predict(fitlm_ETDIGVTGGGQGK_noFAIMS), predict(fitlm_ETDIGVTGGGQGK_FAIMS)), predict_ETDIGVTGGGQK$IonMobility <- c(rep("noFAIMS",6), rep("FAIMS", 6))))
colnames(predict_ETDIGVTGGGQK) <- c("Predicted", "IonMobility")
predict_ETDIGVTGGGQK$Predicted <- as.numeric(predict_ETDIGVTGGGQK$Predicted)
predict_ETDIGVTGGGQK$Concentration <- rep(c(15.625,31.250, 62.5, 125.0, 250.0, 500.0),2)



summary(lm(fitlm_ETDIGVTGGGQGK))$r.squared


Combined_Ratio_SpikeMatrixLadder_ETDIGVTGGGQGK_All_ordered$IonMobility <- as.factor(Combined_Ratio_SpikeMatrixLadder_ETDIGVTGGGQGK_All_ordered$IonMobility)
ggplot(Combined_Ratio_SpikeMatrixLadder_ETDIGVTGGGQGK_All_ordered, aes(x= Concentration, y=x, group = IonMobility)) +
  geom_point(aes(color = IonMobility), size = 4, alpha = 0.5) +
  #geom_line(aes(color = "black")) +
  geom_errorbar(aes(ymin = x-stdev, ymax = x+stdev),
                alpha = 0.2,
                width = 0,
                size= 10,
                color= "#6D696F") +
  geom_line(data=predict_ETDIGVTGGGQK, aes(x=Concentration,y=Predicted, color = IonMobility))+
  theme_classic()+
  #theme(axis.text.x = element_text(angle = 0, hjust = 1))+
  labs(title = "Standard Spiked in Matrix", subtitle = "Heavy to Light Ratio - ETDIGVTGGGQGK",
       x = "Concentration (fmol/uL)", y = "heavy to light Ratio")

```


```{r,echo=FALSE}
Ratio_SpikeMatrixLadder_AIEIVDQALDR_All$IonMobility <- rep("noFAIMS", nrow(Ratio_SpikeMatrixLadder_ETDIGVTGGGQGK_All))
Ratio_FAIMS_SpikeMatrixLadder_AIEIVDQALDR_All$IonMobility <- rep("FAIMS", nrow(Ratio_FAIMS_SpikeMatrixLadder_AIEIVDQALDR_All))

Combined_Ratio_SpikeMatrixLadder_AIEIVDQALDR_All <- rbind(Ratio_SpikeMatrixLadder_AIEIVDQALDR_All,Ratio_FAIMS_SpikeMatrixLadder_AIEIVDQALDR_All[,-5])
Combined_Ratio_SpikeMatrixLadder_AIEIVDQALDR_All$Concentration <- c(Ratio_SpikeMatrixLadder_AIEIVDQALDR_All$Group.1,Ratio_FAIMS_SpikeMatrixLadder_AIEIVDQALDR_All$Concentration)
Combined_Ratio_SpikeMatrixLadder_AIEIVDQALDR_All <- Combined_Ratio_SpikeMatrixLadder_AIEIVDQALDR_All[order(Combined_Ratio_SpikeMatrixLadder_AIEIVDQALDR_All$Concentration),]

Combined_Ratio_SpikeMatrixLadder_AIEIVDQALDR_All$Type <- paste0(Combined_Ratio_SpikeMatrixLadder_AIEIVDQALDR_All$Group.1, Combined_Ratio_SpikeMatrixLadder_AIEIVDQALDR_All$IonMobility)

order_concentration <- factor(Combined_Ratio_SpikeMatrixLadder_AIEIVDQALDR_All$Group.1, levels = c("15.625", "31.25", "62.5", "125", "125reinject", 
                                                                                                "250", "250reinject", "500", "500reinject"))


Combined_Ratio_SpikeMatrixLadder_AIEIVDQALDR_All_ordered <- Combined_Ratio_SpikeMatrixLadder_AIEIVDQALDR_All %>%
  mutate(Group.1 = factor(Group.1, level = levels(order_concentration)))

fitlm_AIEIVDQALDR <- lm(x ~ Concentration, data = Combined_Ratio_SpikeMatrixLadder_AIEIVDQALDR_All_ordered)
Combined_Ratio_SpikeMatrixLadder_AIEIVDQALDR_All_ordered$predlm <- predict(fitlm_AIEIVDQALDR)

summary(lm(fitlm_AIEIVDQALDR))$r.squared

fitlm_AIEIVDQALDR_noFAIMS <- lm(x ~ Concentration, data = Combined_Ratio_SpikeMatrixLadder_AIEIVDQALDR_All_ordered[grep("noFAIMS",Combined_Ratio_SpikeMatrixLadder_AIEIVDQALDR_All_ordered$IonMobility),])
fitlm_AIEIVDQALDR_FAIMS <- lm(x ~ Concentration, data = Combined_Ratio_SpikeMatrixLadder_AIEIVDQALDR_All_ordered[-grep("noFAIMS",Combined_Ratio_SpikeMatrixLadder_AIEIVDQALDR_All_ordered$IonMobility),])

  
predict_AIEIVDQALDR <- as.data.frame(cbind(c(predict(fitlm_AIEIVDQALDR_noFAIMS), predict(fitlm_AIEIVDQALDR_FAIMS)),c(rep("noFAIMS",6), rep("FAIMS", 6))))
colnames(predict_AIEIVDQALDR) <- c("Predicted", "IonMobility")
predict_AIEIVDQALDR$Predicted <- as.numeric(predict_AIEIVDQALDR$Predicted)
predict_AIEIVDQALDR$Concentration <- rep(c(15.625,31.250, 62.5, 125.0, 250.0, 500.0),2)

Combined_Ratio_SpikeMatrixLadder_AIEIVDQALDR_All_ordered$IonMobility <- as.factor(Combined_Ratio_SpikeMatrixLadder_AIEIVDQALDR_All_ordered$IonMobility)
ggplot(Combined_Ratio_SpikeMatrixLadder_AIEIVDQALDR_All_ordered, aes(x= Concentration, y=x, group = IonMobility)) +
  geom_point(aes(color = IonMobility), size = 4, alpha = 0.5) +
  #geom_line(aes(color = "black")) +
  geom_errorbar(aes(ymin = x-stdev, ymax = x+stdev),
                alpha = 0.2,
                width = 0,
                size= 10,
                color= "#6D696F") +
  #geom_line(aes(y=predlm), size = 1)+
  #geom_line(data=predict_AIEIVDQALDR, aes(x=Concentration,y=Predicted, color = IonMobility))+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 50, hjust = 1))+
  labs(title = "Standard Spiked in Matrix", subtitle = "Heavy to Light Ratio - AIEIVDQALDR",
       x = "Concentration (fmol/uL)", y = "heavy to light ratio")

```

```{r,echo=FALSE}
# ggplot(Ratio_SpikeMatrixLadder_ETDIGVTGGGQGK_All, aes(x= Group.1, y=x)) +
#   geom_point(aes(color = "black")) +
#   geom_line(aes(color = "black")) +
#   geom_errorbar(aes(ymin = x-stdev, ymax = x+stdev),
#                 alpha = 0.2,
#                 width = 0,
#                 size= 10,
#                 color= "#6D696F") +
#   theme_classic()
# 
# 
# 
# ggplot(Ratio_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGK_All_ordered, aes(x= Group.1, y=x)) +
#   geom_point(aes(color = "black")) +
#   geom_line(aes(color = "black")) +
#   geom_errorbar(aes(ymin = x-stdev, ymax = x+stdev),
#                 alpha = 0.2,
#                 width = 0,
#                 size= 10,
#                 color= "#6D696F") +
#   theme_classic()

ggplot(All_SpikeMatrixLadder_ETDIGVTGGGQGKheavy, aes(x= Concentration, y=Log2Average_Sum)) +
  geom_point(color = "red") +
  geom_line(color = "red") +
  geom_errorbar(aes(ymin = Log2Average_Sum-Stdev_Log2Sum, ymax = Log2Average_Sum+Stdev_Log2Sum),
                alpha = 0.2,
                width = 0,
                size= 10,
                color= "#6D696F") +
  geom_point(data = Select_SpikeMatrixLadder_ETDIGVTGGGQGKheavy, aes(x= Concentration, y=Log2Average_Sum)) +
  geom_line(data = Select_SpikeMatrixLadder_ETDIGVTGGGQGKheavy, aes(x= Concentration, y=Log2Average_Sum))+
  geom_errorbar(data = Select_SpikeMatrixLadder_ETDIGVTGGGQGKheavy, aes(ymin = Log2Average_Sum-Stdev_Log2Sum, ymax = Log2Average_Sum+Stdev_Log2Sum),
                alpha = 0.2,
                width = 0,
                size= 10,
                color= "#6D696F") +
  geom_point(data = Select_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKheavy, aes(x= Concentration, y=Log2Average_Sum)) +
  #geom_line(data = Select_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKheavy, aes(x= Concentration, y=Log2Average_Sum))+
  geom_errorbar(data = Select_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKheavy, aes(ymin = Log2Average_Sum-Stdev_Log2Sum, ymax = Log2Average_Sum+Stdev_Log2Sum),
                alpha = 0.2,
                width = 0,
                size= 10,
                color= "#6D696F") +
    geom_point(data = All_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKheavy, aes(x= Concentration, y=Log2Average_Sum), color = "red") +
  #geom_line(data = Select_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKheavy, aes(x= Concentration, y=Log2Average_Sum))+
  geom_errorbar(data = All_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKheavy, aes(ymin = Log2Average_Sum-Stdev_Log2Sum, ymax = Log2Average_Sum+Stdev_Log2Sum),
                alpha = 0.2,
                width = 0,
                size= 10,
                color= "#6D696F") +
  theme_classic()+
    labs(title = "Standard Spiked in Matrix", subtitle = "Transitions for heavy ETDIGVTGGGQGK standard - no FAIMS and FAIMS",
       x = "Concentration (fmol/uL)", y = "Log2(Average Sum of Intensity)")
```


```{r,echo=FALSE}
ggplot(All_SpikeMatrixLadder_AIEIVDQALDRheavy, aes(x= Concentration, y=Log2Average_Sum)) +
  geom_point(color = "red") +
  geom_line(color = "red") +
  geom_errorbar(aes(ymin = Log2Average_Sum-Stdev_Log2Sum, ymax = Log2Average_Sum+Stdev_Log2Sum),
                alpha = 0.2,
                width = 0,
                size= 10,
                color= "#6D696F") +
  geom_point(data = Select_SpikeMatrixLadder_AIEIVDQALDRheavy, aes(x= Concentration, y=Log2Average_Sum)) +
  geom_line(data = Select_SpikeMatrixLadder_AIEIVDQALDRheavy, aes(x= Concentration, y=Log2Average_Sum))+
  geom_errorbar(data = Select_SpikeMatrixLadder_AIEIVDQALDRheavy, aes(ymin = Log2Average_Sum-Stdev_Log2Sum, ymax = Log2Average_Sum+Stdev_Log2Sum),
                alpha = 0.2,
                width = 0,
                size= 10,
                color= "#6D696F") +
  geom_point(data = Select_FAIMS_SpikeMatrixLadder_AIEIVDQALDRheavy, aes(x= Concentration, y=Log2Average_Sum)) +
  #geom_line(data = Select_FAIMS_SpikeMatrixLadder_AIEIVDQALDRheavy, aes(x= Concentration, y=Log2Average_Sum))+
  geom_errorbar(data = Select_FAIMS_SpikeMatrixLadder_AIEIVDQALDRheavy, aes(ymin = Log2Average_Sum-Stdev_Log2Sum, ymax = Log2Average_Sum+Stdev_Log2Sum),
                alpha = 0.2,
                width = 0,
                size= 10,
                color= "#6D696F") +
    geom_point(data = All_FAIMS_SpikeMatrixLadder_AIEIVDQALDRheavy, aes(x= Concentration, y=Log2Average_Sum), color = "red") +
  #geom_line(data = Select_FAIMS_SpikeMatrixLadder_AIEIVDQALDRheavy, aes(x= Concentration, y=Log2Average_Sum))+
  geom_errorbar(data = All_FAIMS_SpikeMatrixLadder_AIEIVDQALDRheavy, aes(ymin = Log2Average_Sum-Stdev_Log2Sum, ymax = Log2Average_Sum+Stdev_Log2Sum),
                alpha = 0.2,
                width = 0,
                size= 10,
                color= "#6D696F") +
  theme_classic()+
    labs(title = "Standard Spiked in Matrix", subtitle = "Transitions for heavy AIEIVDQALDR standard - no FAIMS and FAIMS",
       x = "Concentration (fmol/uL)", y = "Log2(Average Sum of Intensity)")

ggplot(Select_FAIMS_SpikeMatrixLadder_ETDIGVTGGGQGKheavy, aes(x= Concentration, y=Log2Average_Sum)) +
  geom_point(color = "red") +
  geom_line(color = "red") +
  geom_errorbar(aes(ymin = Log2Average_Sum-Stdev_Log2Sum, ymax = Log2Average_Sum+Stdev_Log2Sum),
                alpha = 0.2,
                width = 0,
                size= 10,
                color= "#6D696F") +
  geom_point(data = Select_SpikeMatrixLadder_AIEIVDQALDRheavy, aes(x= Concentration, y=Log2Average_Sum)) +
  geom_line(data = Select_SpikeMatrixLadder_AIEIVDQALDRheavy, aes(x= Concentration, y=Log2Average_Sum))+
  geom_errorbar(data = Select_SpikeMatrixLadder_AIEIVDQALDRheavy, aes(ymin = Log2Average_Sum-Stdev_Log2Sum, ymax = Log2Average_Sum+Stdev_Log2Sum),
                alpha = 0.2,
                width = 0,
                size= 10,
                color= "#6D696F") +
  theme_classic()


  xlim(0,180)+
  theme_classic()+
  labs(title = "Time Course IspH Over Expression Monitoring", subtitle = "Light to Heavy Ratio - AIEIVDQALDR",
       x = "Time (min)", y = "Light to Heavy Ratio")

```